<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>APM:Libraries: libraries/AP_L1_Control/AP_L1_Control.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">APM:Libraries
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_bc0718b08fb2015b8e59c47b2805f60c.html">libraries</a></li><li class="navelem"><a class="el" href="dir_996afca1045a8e10427e3ac1dce1c154.html">AP_L1_Control</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">AP_L1_Control.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="AP__L1__Control_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="AP__HAL_8h.html">AP_HAL/AP_HAL.h</a>&gt;</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="AP__L1__Control_8h.html">AP_L1_Control.h</a>&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">extern</span> <span class="keyword">const</span> <a class="code" href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a>&amp; <a class="code" href="AP__L1__Control_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a>;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// table of user settable parameters</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">const</span> <a class="code" href="structAP__Param_1_1GroupInfo.html">AP_Param::GroupInfo</a> <a class="code" href="classAP__L1__Control.html#aa80fb1f9f7ca34cd3da895ab4e9b4436">AP_L1_Control::var_info</a>[] = {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    <span class="comment">// @Param: PERIOD</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    <span class="comment">// @DisplayName: L1 control period</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    <span class="comment">// @Description: Period in seconds of L1 tracking loop. This parameter is the primary control for agressiveness of turns in auto mode. This needs to be larger for less responsive airframes. The default of 20 is quite conservative, but for most RC aircraft will lead to reasonable flight. For smaller more agile aircraft a value closer to 15 is appropriate, or even as low as 10 for some very agile aircraft. When tuning, change this value in small increments, as a value that is much too small (say 5 or 10 below the right value) can lead to very radical turns, and a risk of stalling.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    <span class="comment">// @Units: s</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    <span class="comment">// @Range: 1 60</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    <span class="comment">// @Increment: 1</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    <span class="comment">// @User: Standard</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;PERIOD&quot;</span>,    0, <a class="code" href="classAP__L1__Control.html">AP_L1_Control</a>, _L1_period, 17),</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    <span class="comment">// @Param: DAMPING</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    <span class="comment">// @DisplayName: L1 control damping ratio</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    <span class="comment">// @Description: Damping ratio for L1 control. Increase this in increments of 0.05 if you are getting overshoot in path tracking. You should not need a value below 0.7 or above 0.85.</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    <span class="comment">// @Range: 0.6 1.0</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    <span class="comment">// @Increment: 0.05</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;DAMPING&quot;</span>,   1, <a class="code" href="classAP__L1__Control.html">AP_L1_Control</a>, _L1_damping, 0.75<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>),</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <span class="comment">// @Param: XTRACK_I</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    <span class="comment">// @DisplayName: L1 control crosstrack integrator gain</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    <span class="comment">// @Description: Crosstrack error integrator gain. This gain is applied to the crosstrack error to ensure it converges to zero. Set to zero to disable. Smaller values converge slower, higher values will cause crosstrack error oscillation.</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="comment">// @Range: 0 0.1</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="comment">// @Increment: 0.01</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    <a class="code" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;XTRACK_I&quot;</span>,   2, <a class="code" href="classAP__L1__Control.html">AP_L1_Control</a>, _L1_xtrack_i_gain, 0.02),</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="comment">// @Param: LIM_BANK</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    <span class="comment">// @DisplayName: Loiter Radius Bank Angle Limit</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    <span class="comment">// @Description: The sealevel bank angle limit for a continous loiter. (Used to calculate airframe loading limits at higher altitudes). Setting to 0, will instead just scale the loiter radius directly</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <span class="comment">// @Units: deg</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="comment">// @Range: 0 89</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">// @User: Advanced</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <a class="code" href="AP__Param_8h.html#a752a6a1d27589c64a386ab2818e7057d">AP_GROUPINFO_FRAME</a>(<span class="stringliteral">&quot;LIM_BANK&quot;</span>,   3, <a class="code" href="classAP__L1__Control.html">AP_L1_Control</a>, _loiter_bank_limit, 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, <a class="code" href="AP__Param_8h.html#a5def49b63b71690b19ea5a19ee3b4788">AP_PARAM_FRAME_PLANE</a>),</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <a class="code" href="AP__Param_8h.html#a0f9acb038a5283b964b862aea8cc5051">AP_GROUPEND</a></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;};</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">//Bank angle command based on angle between aircraft velocity vector and reference vector to path.</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">//S. Park, J. Deyst, and J. P. How, &quot;A New Nonlinear Guidance Logic for Trajectory Tracking,&quot;</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">//Proceedings of the AIAA Guidance, Navigation and Control</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">//Conference, Aug 2004. AIAA-2004-4900.</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">//Modified to use PD control for circle tracking to enable loiter radius less than L1 length</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">//Modified to enable period and damping of guidance loop to be set explicitly</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment">//Modified to provide explicit control over capture angle</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">  Wrap AHRS yaw if in reverse - radians</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#ab80fcf9f4408e4c3a70af6fa89da20d3">   56</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAP__L1__Control.html#ab80fcf9f4408e4c3a70af6fa89da20d3">AP_L1_Control::get_yaw</a>()</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;{</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAP__L1__Control.html#a9290bef1192d5649fa929e1feefe21da">_reverse</a>) {</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="AP__Math_8cpp.html#a21d0562d7b23dd9f04bc30a3611cc577">wrap_PI</a>(<a class="code" href="definitions_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> + <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a63359ca9325c63642050bcf1c3e1cd63">yaw</a>);</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    }</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a63359ca9325c63642050bcf1c3e1cd63">yaw</a>;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;}</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">  Wrap AHRS yaw sensor if in reverse - centi-degress</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00067"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#ac558013977299a03d6c8cdd61559561d">   67</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAP__L1__Control.html#ac558013977299a03d6c8cdd61559561d">AP_L1_Control::get_yaw_sensor</a>()</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;{</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAP__L1__Control.html#a9290bef1192d5649fa929e1feefe21da">_reverse</a>) {</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="AP__Math_8cpp.html#a4e136782e86e2adaaf7f0f759067dfe1">wrap_180_cd</a>(18000 + <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a8a160130dd99016a19abab9d85917261">yaw_sensor</a>);</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    }</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a8a160130dd99016a19abab9d85917261">yaw_sensor</a>;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;}</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">  return the bank angle needed to achieve tracking from the last</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">  update_*() operation</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00079"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a452628329b2b1c6fd9db864997c71e62">   79</a></span>&#160;int32_t <a class="code" href="classAP__L1__Control.html#a452628329b2b1c6fd9db864997c71e62">AP_L1_Control::nav_roll_cd</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keywordtype">float</span> ret;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    ret = cosf(<a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a2aa61744614d8e0ef64803583359a56e">pitch</a>)*<a class="code" href="moduletest_8c.html#a903c4797a4c2860e3b9a6a978f98a44d">degrees</a>(atanf(<a class="code" href="classAP__L1__Control.html#a62654b078823ca555139cf64403b5442">_latAccDem</a> * 0.101972<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) * 100.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>); <span class="comment">// 0.101972 = 1/9.81</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    ret = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(ret, -9000, 9000);</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;}</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment">  return the lateral acceleration needed to achieve tracking from the last</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment">  update_*() operation</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00091"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a34f586604201ae335fe7e3d06f5a1fc4">   91</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAP__L1__Control.html#a34f586604201ae335fe7e3d06f5a1fc4">AP_L1_Control::lateral_acceleration</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAP__L1__Control.html#a62654b078823ca555139cf64403b5442">_latAccDem</a>;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;}</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a763a962db3c7a199ee9d3fcd7f42e1ff">   96</a></span>&#160;int32_t <a class="code" href="classAP__L1__Control.html#a763a962db3c7a199ee9d3fcd7f42e1ff">AP_L1_Control::nav_bearing_cd</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="AP__Math_8cpp.html#a4e136782e86e2adaaf7f0f759067dfe1">wrap_180_cd</a>(<a class="code" href="definitions_8h.html#a96799f9de58a211f6b3bdc96c6e10669">RadiansToCentiDegrees</a>(<a class="code" href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">_nav_bearing</a>));</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a41a8ab916024b77959ed059dd12469a1">  101</a></span>&#160;int32_t <a class="code" href="classAP__L1__Control.html#a41a8ab916024b77959ed059dd12469a1">AP_L1_Control::bearing_error_cd</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="definitions_8h.html#a96799f9de58a211f6b3bdc96c6e10669">RadiansToCentiDegrees</a>(<a class="code" href="classAP__L1__Control.html#a2f25d6cea6e98aaec7d7a191537da195">_bearing_error</a>);</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;}</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a0c6970cc071d4843f0fe983003cc1410">  106</a></span>&#160;int32_t <a class="code" href="classAP__L1__Control.html#a0c6970cc071d4843f0fe983003cc1410">AP_L1_Control::target_bearing_cd</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="AP__Math_8cpp.html#a4e136782e86e2adaaf7f0f759067dfe1">wrap_180_cd</a>(<a class="code" href="classAP__L1__Control.html#aebee3748e799d62f42ab2fbe8afadb9e">_target_bearing_cd</a>);</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;}</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">  this is the turn distance assuming a 90 degree turn</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00114"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#ab99bfec3eb21aa7b9dc1edef4cc60fc0">  114</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAP__L1__Control.html#ab99bfec3eb21aa7b9dc1edef4cc60fc0">AP_L1_Control::turn_distance</a>(<span class="keywordtype">float</span> wp_radius)<span class="keyword"> const</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    wp_radius *= <a class="code" href="AP__Math_8h.html#a0375e3d67fd3911cacee5c3e1408c0f2">sq</a>(<a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a64786b58a1607ee420ed4f0696c755b6">get_EAS2TAS</a>());</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="AP__Math_8h.html#a321a91de43cfb2e95d40cde314d0a80f">MIN</a>(wp_radius, <a class="code" href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">_L1_dist</a>);</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;}</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">  this approximates the turn distance for a given turn angle. If the</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">  turn_angle is &gt; 90 then a 90 degree turn distance is used, otherwise</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">  the turn distance is reduced linearly.</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">  This function allows straight ahead mission legs to avoid thinking</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">  they have reached the waypoint early, which makes things like camera</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">  trigger and ball drop at exact positions under mission control much easier</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00128"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a82b5fb67863a95fc5de9451994e68ee0">  128</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAP__L1__Control.html#ab99bfec3eb21aa7b9dc1edef4cc60fc0">AP_L1_Control::turn_distance</a>(<span class="keywordtype">float</span> wp_radius, <span class="keywordtype">float</span> turn_angle)<span class="keyword"> const</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordtype">float</span> distance_90 = <a class="code" href="classAP__L1__Control.html#ab99bfec3eb21aa7b9dc1edef4cc60fc0">turn_distance</a>(wp_radius);</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    turn_angle = fabsf(turn_angle);</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="keywordflow">if</span> (turn_angle &gt;= 90) {</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">return</span> distance_90;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    }</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">return</span> distance_90 * turn_angle / 90.0f;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;}</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a2f30082f502f02b94d754c6bb735f70b">  138</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classAP__L1__Control.html#a2f30082f502f02b94d754c6bb735f70b">AP_L1_Control::loiter_radius</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> radius)<span class="keyword"> const</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="comment">// prevent an insane loiter bank limit</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="keywordtype">float</span> sanitized_bank_limit = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAP__L1__Control.html#a694095425105d37dd52aeb275925f6d7">_loiter_bank_limit</a>, 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, 89.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="keywordtype">float</span> lateral_accel_sea_level = tanf(<a class="code" href="AP__Math_8h.html#a37d7c62a8231d9d22826261297b99da4">radians</a>(sanitized_bank_limit)) * <a class="code" href="definitions_8h.html#aea8758bf61b23b46507902b46060ebfd">GRAVITY_MSS</a>;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordtype">float</span> nominal_velocity_sea_level;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="classAP__L1__Control.html#af4402fcd7040bd1779f88cec082cbe36">_spdHgtControl</a> == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        nominal_velocity_sea_level = 0.0f;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        nominal_velocity_sea_level =  <a class="code" href="classAP__L1__Control.html#af4402fcd7040bd1779f88cec082cbe36">_spdHgtControl</a>-&gt;<a class="code" href="classAP__SpdHgtControl.html#aef400289c2cdf6c24d39f3c93b82df37">get_target_airspeed</a>();</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    }</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordtype">float</span> eas2tas_sq = <a class="code" href="AP__Math_8h.html#a0375e3d67fd3911cacee5c3e1408c0f2">sq</a>(<a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a64786b58a1607ee420ed4f0696c755b6">get_EAS2TAS</a>());</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(sanitized_bank_limit) || <a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(nominal_velocity_sea_level) ||</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <a class="code" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(lateral_accel_sea_level)) {</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="comment">// Missing a sane input for calculating the limit, or the user has</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="comment">// requested a straight scaling with altitude. This will always vary</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <span class="comment">// with the current altitude, but will at least protect the airframe</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keywordflow">return</span> radius * eas2tas_sq;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="keywordtype">float</span> sea_level_radius = <a class="code" href="AP__Math_8h.html#a0375e3d67fd3911cacee5c3e1408c0f2">sq</a>(nominal_velocity_sea_level) / lateral_accel_sea_level;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="keywordflow">if</span> (sea_level_radius &gt; radius) {</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            <span class="comment">// If we&#39;ve told the plane that its sea level radius is unachievable fallback to</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            <span class="comment">// straight altitude scaling</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            <span class="keywordflow">return</span> radius * eas2tas_sq;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;            <span class="comment">// select the requested radius, or the required altitude scale, whichever is safer</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>(sea_level_radius * eas2tas_sq, radius);</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        }</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    }</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;}</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div><div class="line"><a name="l00172"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a960b675b15f9850e1ba8d9c878e972bc">  172</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classAP__L1__Control.html#a960b675b15f9850e1ba8d9c878e972bc">AP_L1_Control::reached_loiter_target</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;{</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classAP__L1__Control.html#a39ccead440555e0e4abc52ab71e9fac8">_WPcircle</a>;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;}</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#aaa154ba9c5957f90785c34ee554eca1c">  182</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAP__L1__Control.html#aaa154ba9c5957f90785c34ee554eca1c">AP_L1_Control::_prevent_indecision</a>(<span class="keywordtype">float</span> &amp;Nu)</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;{</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> Nu_limit = 0.9f*<a class="code" href="definitions_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="keywordflow">if</span> (fabsf(Nu) &gt; Nu_limit &amp;&amp;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        fabsf(<a class="code" href="classAP__L1__Control.html#a67c543ed97304d5d11433f83d4f53280">_last_Nu</a>) &gt; Nu_limit &amp;&amp;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        labs(<a class="code" href="AP__Math_8cpp.html#a4e136782e86e2adaaf7f0f759067dfe1">wrap_180_cd</a>(<a class="code" href="classAP__L1__Control.html#aebee3748e799d62f42ab2fbe8afadb9e">_target_bearing_cd</a> - <a class="code" href="classAP__L1__Control.html#ac558013977299a03d6c8cdd61559561d">get_yaw_sensor</a>())) &gt; 12000 &amp;&amp;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        Nu * <a class="code" href="classAP__L1__Control.html#a67c543ed97304d5d11433f83d4f53280">_last_Nu</a> &lt; 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        <span class="comment">// we are moving away from the target waypoint and pointing</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="comment">// away from the waypoint (not flying backwards). The sign</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="comment">// of Nu has also changed, which means we are</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="comment">// oscillating in our decision about which way to go</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        Nu = <a class="code" href="classAP__L1__Control.html#a67c543ed97304d5d11433f83d4f53280">_last_Nu</a>;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    }</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;}</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">// update L1 control for waypoint navigation</span></div><div class="line"><a name="l00198"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a545690fe6188ee32805f5e33cc3da1bc">  198</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAP__L1__Control.html#a545690fe6188ee32805f5e33cc3da1bc">AP_L1_Control::update_waypoint</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="classLocation.html">Location</a> &amp;prev_WP, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="classLocation.html">Location</a> &amp;next_WP, <span class="keywordtype">float</span> dist_min)</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;{</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keyword">struct </span><a class="code" href="classLocation.html">Location</a> _current_loc;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordtype">float</span> Nu;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordtype">float</span> xtrackVel;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordtype">float</span> ltrackVel;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    uint32_t now = <a class="code" href="namespaceAP__HAL.html#a8293355e35887733b1fd151aef08a787">AP_HAL::micros</a>();</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordtype">float</span> dt = (now - <a class="code" href="classAP__L1__Control.html#a79bf5c44d2e7cd540ff846870593307f">_last_update_waypoint_us</a>) * 1.0e-6<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="keywordflow">if</span> (dt &gt; 0.1) {</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        dt = 0.1;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <a class="code" href="classAP__L1__Control.html#a74021d6b9cf1c7df17624b0a28ae0d7c">_L1_xtrack_i</a> = 0.0f;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    }</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <a class="code" href="classAP__L1__Control.html#a79bf5c44d2e7cd540ff846870593307f">_last_update_waypoint_us</a> = now;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="comment">// Calculate L1 gain required for specified damping</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordtype">float</span> K_L1 = 4.0f * <a class="code" href="classAP__L1__Control.html#a5f64f08c05c9152ff92202150b9ce05e">_L1_damping</a> * <a class="code" href="classAP__L1__Control.html#a5f64f08c05c9152ff92202150b9ce05e">_L1_damping</a>;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// Get current position and velocity</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a861802533d7f8a91efc39425ac9c724f">get_position</a>(_current_loc) == <span class="keyword">false</span>) {</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="comment">// if no GPS loc available, maintain last nav/target_bearing</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <a class="code" href="classAP__L1__Control.html#a961307861e61bcbef3147295ccba450b">_data_is_stale</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    }</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <a class="code" href="structVector2.html">Vector2f</a> _groundspeed_vector = <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#aa2fd48ce0265df723cc8d05bb2150749">groundspeed_vector</a>();</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="comment">// update _target_bearing_cd</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <a class="code" href="classAP__L1__Control.html#aebee3748e799d62f42ab2fbe8afadb9e">_target_bearing_cd</a> = _current_loc.<a class="code" href="classLocation.html#a48a312dc9de608dda0fe65c5e6f3bf58">get_bearing_to</a>(next_WP);</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="comment">//Calculate groundspeed</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordtype">float</span> groundSpeed = _groundspeed_vector.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>();</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keywordflow">if</span> (groundSpeed &lt; 0.1<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="comment">// use a small ground speed vector in the right direction,</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="comment">// allowing us to use the compass heading at zero GPS velocity</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        groundSpeed = 0.1f;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        _groundspeed_vector = <a class="code" href="vector2_8h.html#a9f3739462b0605dcb64299fa289b6afe">Vector2f</a>(cosf(<a class="code" href="classAP__L1__Control.html#ab80fcf9f4408e4c3a70af6fa89da20d3">get_yaw</a>()), sinf(<a class="code" href="classAP__L1__Control.html#ab80fcf9f4408e4c3a70af6fa89da20d3">get_yaw</a>())) * groundSpeed;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    }</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="comment">// Calculate time varying control parameters</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="comment">// Calculate the L1 length required for specified period</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="comment">// 0.3183099 = 1/1/pipi</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <a class="code" href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">_L1_dist</a> = <a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>(0.3183099<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> * <a class="code" href="classAP__L1__Control.html#a5f64f08c05c9152ff92202150b9ce05e">_L1_damping</a> * <a class="code" href="classAP__L1__Control.html#a56dece11a108acd6b733efb497a614f5">_L1_period</a> * groundSpeed, dist_min);</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="comment">// Calculate the NE position of WP B relative to WP A</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <a class="code" href="structVector2.html">Vector2f</a> AB = prev_WP.<a class="code" href="classLocation.html#af597420e2ec20fc794ca3d5447fd36ba">get_distance_NE</a>(next_WP);</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keywordtype">float</span> AB_length = AB.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>();</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="comment">// Check for AB zero length and track directly to the destination</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="comment">// if too small</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordflow">if</span> (AB.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>() &lt; 1.0e-6<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        AB = _current_loc.<a class="code" href="classLocation.html#af597420e2ec20fc794ca3d5447fd36ba">get_distance_NE</a>(next_WP);</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="keywordflow">if</span> (AB.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>() &lt; 1.0e-6<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            AB = <a class="code" href="vector2_8h.html#a9f3739462b0605dcb64299fa289b6afe">Vector2f</a>(cosf(<a class="code" href="classAP__L1__Control.html#ab80fcf9f4408e4c3a70af6fa89da20d3">get_yaw</a>()), sinf(<a class="code" href="classAP__L1__Control.html#ab80fcf9f4408e4c3a70af6fa89da20d3">get_yaw</a>()));</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        }</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    }</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    AB.<a class="code" href="structVector2.html#ace2a626eaa79412e2946216e9c3e63c6">normalize</a>();</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="comment">// Calculate the NE position of the aircraft relative to WP A</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keyword">const</span> <a class="code" href="structVector2.html">Vector2f</a> A_air = prev_WP.<a class="code" href="classLocation.html#af597420e2ec20fc794ca3d5447fd36ba">get_distance_NE</a>(_current_loc);</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="comment">// calculate distance to target track, for reporting</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <a class="code" href="classAP__L1__Control.html#a077f59318a8244068f1ba9a19831225a">_crosstrack_error</a> = A_air % AB;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="comment">//Determine if the aircraft is behind a +-135 degree degree arc centred on WP A</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="comment">//and further than L1 distance from WP A. Then use WP A as the L1 reference point</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="comment">//Otherwise do normal L1 guidance</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keywordtype">float</span> WP_A_dist = A_air.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>();</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keywordtype">float</span> alongTrackDist = A_air * AB;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keywordflow">if</span> (WP_A_dist &gt; <a class="code" href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">_L1_dist</a> &amp;&amp; alongTrackDist/<a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>(WP_A_dist, 1.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) &lt; -0.7071<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>)</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    {</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="comment">//Calc Nu to fly To WP A</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        <a class="code" href="structVector2.html">Vector2f</a> A_air_unit = (A_air).normalized(); <span class="comment">// Unit vector from WP A to aircraft</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        xtrackVel = _groundspeed_vector % (-A_air_unit); <span class="comment">// Velocity across line</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        ltrackVel = _groundspeed_vector * (-A_air_unit); <span class="comment">// Velocity along line</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        Nu = atan2f(xtrackVel,ltrackVel);</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <a class="code" href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">_nav_bearing</a> = atan2f(-A_air_unit.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> , -A_air_unit.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a>); <span class="comment">// bearing (radians) from AC to L1 point</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (alongTrackDist &gt; AB_length + groundSpeed*3) {</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="comment">// we have passed point B by 3 seconds. Head towards B</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <span class="comment">// Calc Nu to fly To WP B</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        <span class="keyword">const</span> <a class="code" href="structVector2.html">Vector2f</a> B_air = next_WP.<a class="code" href="classLocation.html#af597420e2ec20fc794ca3d5447fd36ba">get_distance_NE</a>(_current_loc);</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <a class="code" href="structVector2.html">Vector2f</a> B_air_unit = (B_air).normalized(); <span class="comment">// Unit vector from WP B to aircraft</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        xtrackVel = _groundspeed_vector % (-B_air_unit); <span class="comment">// Velocity across line</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        ltrackVel = _groundspeed_vector * (-B_air_unit); <span class="comment">// Velocity along line</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        Nu = atan2f(xtrackVel,ltrackVel);</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <a class="code" href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">_nav_bearing</a> = atan2f(-B_air_unit.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> , -B_air_unit.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a>); <span class="comment">// bearing (radians) from AC to L1 point</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    } <span class="keywordflow">else</span> { <span class="comment">//Calc Nu to fly along AB line</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="comment">//Calculate Nu2 angle (angle of velocity vector relative to line connecting waypoints)</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        xtrackVel = _groundspeed_vector % AB; <span class="comment">// Velocity cross track</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        ltrackVel = _groundspeed_vector * AB; <span class="comment">// Velocity along track</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="keywordtype">float</span> Nu2 = atan2f(xtrackVel,ltrackVel);</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="comment">//Calculate Nu1 angle (Angle to L1 reference point)</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keywordtype">float</span> sine_Nu1 = <a class="code" href="classAP__L1__Control.html#a077f59318a8244068f1ba9a19831225a">_crosstrack_error</a>/<a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>(<a class="code" href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">_L1_dist</a>, 0.1<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="comment">//Limit sine of Nu1 to provide a controlled track capture angle of 45 deg</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        sine_Nu1 = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(sine_Nu1, -0.7071<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, 0.7071<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="keywordtype">float</span> Nu1 = asinf(sine_Nu1);</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="comment">// compute integral error component to converge to a crosstrack of zero when traveling</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="comment">// straight but reset it when disabled or if it changes. That allows for much easier</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="comment">// tuning by having it re-converge each time it changes.</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classAP__L1__Control.html#a45e259577f46c8cdfe5f52bece257019">_L1_xtrack_i_gain</a> &lt;= 0 || !<a class="code" href="AP__Math_8cpp.html#accbd9f8bbc0adacd51efa66fad490c24">is_equal</a>(<a class="code" href="classAP__L1__Control.html#a45e259577f46c8cdfe5f52bece257019">_L1_xtrack_i_gain</a>.get(), <a class="code" href="classAP__L1__Control.html#a725b90895d4de350044edbe07ed38613">_L1_xtrack_i_gain_prev</a>)) {</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            <a class="code" href="classAP__L1__Control.html#a74021d6b9cf1c7df17624b0a28ae0d7c">_L1_xtrack_i</a> = 0;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            <a class="code" href="classAP__L1__Control.html#a725b90895d4de350044edbe07ed38613">_L1_xtrack_i_gain_prev</a> = <a class="code" href="classAP__L1__Control.html#a45e259577f46c8cdfe5f52bece257019">_L1_xtrack_i_gain</a>;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fabsf(Nu1) &lt; <a class="code" href="AP__Math_8h.html#a37d7c62a8231d9d22826261297b99da4">radians</a>(5)) {</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            <a class="code" href="classAP__L1__Control.html#a74021d6b9cf1c7df17624b0a28ae0d7c">_L1_xtrack_i</a> += Nu1 * <a class="code" href="classAP__L1__Control.html#a45e259577f46c8cdfe5f52bece257019">_L1_xtrack_i_gain</a> * dt;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            <span class="comment">// an AHRS_TRIM_X=0.1 will drift to about 0.08 so 0.1 is a good worst-case to clip at</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;            <a class="code" href="classAP__L1__Control.html#a74021d6b9cf1c7df17624b0a28ae0d7c">_L1_xtrack_i</a> = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(<a class="code" href="classAP__L1__Control.html#a74021d6b9cf1c7df17624b0a28ae0d7c">_L1_xtrack_i</a>, -0.1<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, 0.1<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        }</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        <span class="comment">// to converge to zero we must push Nu1 harder</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        Nu1 += <a class="code" href="classAP__L1__Control.html#a74021d6b9cf1c7df17624b0a28ae0d7c">_L1_xtrack_i</a>;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        Nu = Nu1 + Nu2;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <a class="code" href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">_nav_bearing</a> = atan2f(AB.y, AB.x) + Nu1; <span class="comment">// bearing (radians) from AC to L1 point</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    }</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <a class="code" href="classAP__L1__Control.html#aaa154ba9c5957f90785c34ee554eca1c">_prevent_indecision</a>(Nu);</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <a class="code" href="classAP__L1__Control.html#a67c543ed97304d5d11433f83d4f53280">_last_Nu</a> = Nu;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="comment">//Limit Nu to +-(pi/2)</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    Nu = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(Nu, -1.5708<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>, +1.5708<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <a class="code" href="classAP__L1__Control.html#a62654b078823ca555139cf64403b5442">_latAccDem</a> = K_L1 * groundSpeed * groundSpeed / <a class="code" href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">_L1_dist</a> * sinf(Nu);</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="comment">// Waypoint capture status is always false during waypoint following</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <a class="code" href="classAP__L1__Control.html#a39ccead440555e0e4abc52ab71e9fac8">_WPcircle</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <a class="code" href="classAP__L1__Control.html#a2f25d6cea6e98aaec7d7a191537da195">_bearing_error</a> = Nu; <span class="comment">// bearing error angle (radians), +ve to left of track</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <a class="code" href="classAP__L1__Control.html#a961307861e61bcbef3147295ccba450b">_data_is_stale</a> = <span class="keyword">false</span>; <span class="comment">// status are correctly updated with current waypoint data</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;}</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">// update L1 control for loitering</span></div><div class="line"><a name="l00333"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a6fc833f318b2ababaa0cf52738c71163">  333</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAP__L1__Control.html#a6fc833f318b2ababaa0cf52738c71163">AP_L1_Control::update_loiter</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="classLocation.html">Location</a> &amp;center_WP, <span class="keywordtype">float</span> radius, int8_t loiter_direction)</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;{</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keyword">struct </span><a class="code" href="classLocation.html">Location</a> _current_loc;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="comment">// scale loiter radius with square of EAS2TAS to allow us to stay</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="comment">// stable at high altitude</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    radius = <a class="code" href="classAP__L1__Control.html#a2f30082f502f02b94d754c6bb735f70b">loiter_radius</a>(fabsf(radius));</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="comment">// Calculate guidance gains used by PD loop (used during circle tracking)</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keywordtype">float</span> omega = (6.2832f / <a class="code" href="classAP__L1__Control.html#a56dece11a108acd6b733efb497a614f5">_L1_period</a>);</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordtype">float</span> Kx = omega * omega;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="keywordtype">float</span> Kv = 2.0f * <a class="code" href="classAP__L1__Control.html#a5f64f08c05c9152ff92202150b9ce05e">_L1_damping</a> * omega;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="comment">// Calculate L1 gain required for specified damping (used during waypoint capture)</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <span class="keywordtype">float</span> K_L1 = 4.0f * <a class="code" href="classAP__L1__Control.html#a5f64f08c05c9152ff92202150b9ce05e">_L1_damping</a> * <a class="code" href="classAP__L1__Control.html#a5f64f08c05c9152ff92202150b9ce05e">_L1_damping</a>;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="comment">//Get current position and velocity</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a861802533d7f8a91efc39425ac9c724f">get_position</a>(_current_loc) == <span class="keyword">false</span>) {</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        <span class="comment">// if no GPS loc available, maintain last nav/target_bearing</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        <a class="code" href="classAP__L1__Control.html#a961307861e61bcbef3147295ccba450b">_data_is_stale</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    }</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <a class="code" href="structVector2.html">Vector2f</a> _groundspeed_vector = <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#aa2fd48ce0265df723cc8d05bb2150749">groundspeed_vector</a>();</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="comment">//Calculate groundspeed</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordtype">float</span> groundSpeed = <a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>(_groundspeed_vector.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>() , 1.0f);</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="comment">// update _target_bearing_cd</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <a class="code" href="classAP__L1__Control.html#aebee3748e799d62f42ab2fbe8afadb9e">_target_bearing_cd</a> = _current_loc.<a class="code" href="classLocation.html#a48a312dc9de608dda0fe65c5e6f3bf58">get_bearing_to</a>(center_WP);</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="comment">// Calculate time varying control parameters</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="comment">// Calculate the L1 length required for specified period</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="comment">// 0.3183099 = 1/pi</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <a class="code" href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">_L1_dist</a> = 0.3183099f * <a class="code" href="classAP__L1__Control.html#a5f64f08c05c9152ff92202150b9ce05e">_L1_damping</a> * <a class="code" href="classAP__L1__Control.html#a56dece11a108acd6b733efb497a614f5">_L1_period</a> * groundSpeed;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="comment">//Calculate the NE position of the aircraft relative to WP A</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="keyword">const</span> <a class="code" href="structVector2.html">Vector2f</a> A_air = center_WP.<a class="code" href="classLocation.html#af597420e2ec20fc794ca3d5447fd36ba">get_distance_NE</a>(_current_loc);</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="comment">// Calculate the unit vector from WP A to aircraft</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="comment">// protect against being on the waypoint and having zero velocity</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="comment">// if too close to the waypoint, use the velocity vector</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="comment">// if the velocity vector is too small, use the heading vector</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <a class="code" href="structVector2.html">Vector2f</a> A_air_unit;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordflow">if</span> (A_air.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>() &gt; 0.1f) {</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        A_air_unit = A_air.<a class="code" href="structVector2.html#aa78ff4778f55bf9c1ba9a10830fc0b89">normalized</a>();</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        <span class="keywordflow">if</span> (_groundspeed_vector.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>() &lt; 0.1f) {</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            A_air_unit = <a class="code" href="vector2_8h.html#a9f3739462b0605dcb64299fa289b6afe">Vector2f</a>(cosf(<a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a63359ca9325c63642050bcf1c3e1cd63">yaw</a>), sinf(<a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a63359ca9325c63642050bcf1c3e1cd63">yaw</a>));</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            A_air_unit = _groundspeed_vector.<a class="code" href="structVector2.html#aa78ff4778f55bf9c1ba9a10830fc0b89">normalized</a>();</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        }</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    }</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="comment">//Calculate Nu to capture center_WP</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordtype">float</span> xtrackVelCap = A_air_unit % _groundspeed_vector; <span class="comment">// Velocity across line - perpendicular to radial inbound to WP</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="keywordtype">float</span> ltrackVelCap = - (_groundspeed_vector * A_air_unit); <span class="comment">// Velocity along line - radial inbound to WP</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="keywordtype">float</span> Nu = atan2f(xtrackVelCap,ltrackVelCap);</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <a class="code" href="classAP__L1__Control.html#aaa154ba9c5957f90785c34ee554eca1c">_prevent_indecision</a>(Nu);</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    <a class="code" href="classAP__L1__Control.html#a67c543ed97304d5d11433f83d4f53280">_last_Nu</a> = Nu;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    Nu = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(Nu, -<a class="code" href="definitions_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a>, <a class="code" href="definitions_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a>); <span class="comment">//Limit Nu to +- Pi/2</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="comment">//Calculate lat accln demand to capture center_WP (use L1 guidance law)</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordtype">float</span> latAccDemCap = K_L1 * groundSpeed * groundSpeed / <a class="code" href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">_L1_dist</a> * sinf(Nu);</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <span class="comment">//Calculate radial position and velocity errors</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="keywordtype">float</span> xtrackVelCirc = -ltrackVelCap; <span class="comment">// Radial outbound velocity - reuse previous radial inbound velocity</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="keywordtype">float</span> xtrackErrCirc = A_air.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>() - radius; <span class="comment">// Radial distance from the loiter circle</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="comment">// keep crosstrack error for reporting</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <a class="code" href="classAP__L1__Control.html#a077f59318a8244068f1ba9a19831225a">_crosstrack_error</a> = xtrackErrCirc;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="comment">//Calculate PD control correction to circle waypoint_ahrs.roll</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="keywordtype">float</span> latAccDemCircPD = (xtrackErrCirc * Kx + xtrackVelCirc * Kv);</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="comment">//Calculate tangential velocity</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordtype">float</span> velTangent = xtrackVelCap * float(loiter_direction);</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="comment">//Prevent PD demand from turning the wrong way by limiting the command when flying the wrong way</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keywordflow">if</span> (ltrackVelCap &lt; 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> &amp;&amp; velTangent &lt; 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>) {</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        latAccDemCircPD =  <a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>(latAccDemCircPD, 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    }</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="comment">// Calculate centripetal acceleration demand</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keywordtype">float</span> latAccDemCircCtr = velTangent * velTangent / <a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>((0.5<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> * radius), (radius + xtrackErrCirc));</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="comment">//Sum PD control and centripetal acceleration to calculate lateral manoeuvre demand</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="keywordtype">float</span> latAccDemCirc = loiter_direction * (latAccDemCircPD + latAccDemCircCtr);</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="comment">// Perform switchover between &#39;capture&#39; and &#39;circle&#39; modes at the</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="comment">// point where the commands cross over to achieve a seamless transfer</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="comment">// Only fly &#39;capture&#39; mode if outside the circle</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="keywordflow">if</span> (xtrackErrCirc &gt; 0.0<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a> &amp;&amp; loiter_direction * latAccDemCap &lt; loiter_direction * latAccDemCirc) {</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        <a class="code" href="classAP__L1__Control.html#a62654b078823ca555139cf64403b5442">_latAccDem</a> = latAccDemCap;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        <a class="code" href="classAP__L1__Control.html#a39ccead440555e0e4abc52ab71e9fac8">_WPcircle</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <a class="code" href="classAP__L1__Control.html#a2f25d6cea6e98aaec7d7a191537da195">_bearing_error</a> = Nu; <span class="comment">// angle between demanded and achieved velocity vector, +ve to left of track</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <a class="code" href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">_nav_bearing</a> = atan2f(-A_air_unit.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> , -A_air_unit.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a>); <span class="comment">// bearing (radians) from AC to L1 point</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <a class="code" href="classAP__L1__Control.html#a62654b078823ca555139cf64403b5442">_latAccDem</a> = latAccDemCirc;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        <a class="code" href="classAP__L1__Control.html#a39ccead440555e0e4abc52ab71e9fac8">_WPcircle</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <a class="code" href="classAP__L1__Control.html#a2f25d6cea6e98aaec7d7a191537da195">_bearing_error</a> = 0.0f; <span class="comment">// bearing error (radians), +ve to left of track</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <a class="code" href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">_nav_bearing</a> = atan2f(-A_air_unit.<a class="code" href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">y</a> , -A_air_unit.<a class="code" href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">x</a>); <span class="comment">// bearing (radians)from AC to L1 point</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    }</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <a class="code" href="classAP__L1__Control.html#a961307861e61bcbef3147295ccba450b">_data_is_stale</a> = <span class="keyword">false</span>; <span class="comment">// status are correctly updated with current waypoint data</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;}</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="comment">// update L1 control for heading hold navigation</span></div><div class="line"><a name="l00446"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a1a7687ed13c74f535087c984968a92a3">  446</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAP__L1__Control.html#a1a7687ed13c74f535087c984968a92a3">AP_L1_Control::update_heading_hold</a>(int32_t navigation_heading_cd)</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;{</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="comment">// Calculate normalised frequency for tracking loop</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> omegaA = 4.4428f/<a class="code" href="classAP__L1__Control.html#a56dece11a108acd6b733efb497a614f5">_L1_period</a>; <span class="comment">// sqrt(2)*pi/period</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="comment">// Calculate additional damping gain</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    int32_t Nu_cd;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="keywordtype">float</span> Nu;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="comment">// copy to _target_bearing_cd and _nav_bearing</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <a class="code" href="classAP__L1__Control.html#aebee3748e799d62f42ab2fbe8afadb9e">_target_bearing_cd</a> = <a class="code" href="AP__Math_8cpp.html#a4e136782e86e2adaaf7f0f759067dfe1">wrap_180_cd</a>(navigation_heading_cd);</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <a class="code" href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">_nav_bearing</a> = <a class="code" href="AP__Math_8h.html#a37d7c62a8231d9d22826261297b99da4">radians</a>(navigation_heading_cd * 0.01<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    Nu_cd = <a class="code" href="classAP__L1__Control.html#aebee3748e799d62f42ab2fbe8afadb9e">_target_bearing_cd</a> - <a class="code" href="AP__Math_8cpp.html#a4e136782e86e2adaaf7f0f759067dfe1">wrap_180_cd</a>(<a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a8a160130dd99016a19abab9d85917261">yaw_sensor</a>);</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    Nu_cd = <a class="code" href="AP__Math_8cpp.html#a4e136782e86e2adaaf7f0f759067dfe1">wrap_180_cd</a>(Nu_cd);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    Nu = <a class="code" href="AP__Math_8h.html#a37d7c62a8231d9d22826261297b99da4">radians</a>(Nu_cd * 0.01<a class="code" href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a>);</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <a class="code" href="structVector2.html">Vector2f</a> _groundspeed_vector = <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#aa2fd48ce0265df723cc8d05bb2150749">groundspeed_vector</a>();</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="comment">//Calculate groundspeed</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordtype">float</span> groundSpeed = _groundspeed_vector.<a class="code" href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">length</a>();</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="comment">// Calculate time varying control parameters</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <a class="code" href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">_L1_dist</a> = groundSpeed / omegaA; <span class="comment">// L1 distance is adjusted to maintain a constant tracking loop frequency</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordtype">float</span> VomegaA = groundSpeed * omegaA;</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="comment">// Waypoint capture status is always false during heading hold</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <a class="code" href="classAP__L1__Control.html#a39ccead440555e0e4abc52ab71e9fac8">_WPcircle</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <a class="code" href="classAP__L1__Control.html#a077f59318a8244068f1ba9a19831225a">_crosstrack_error</a> = 0;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <a class="code" href="classAP__L1__Control.html#a2f25d6cea6e98aaec7d7a191537da195">_bearing_error</a> = Nu; <span class="comment">// bearing error angle (radians), +ve to left of track</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="comment">// Limit Nu to +-pi</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    Nu = <a class="code" href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a>(Nu, -<a class="code" href="definitions_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a>, <a class="code" href="definitions_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a>);</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <a class="code" href="classAP__L1__Control.html#a62654b078823ca555139cf64403b5442">_latAccDem</a> = 2.0f*sinf(Nu)*VomegaA;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <a class="code" href="classAP__L1__Control.html#a961307861e61bcbef3147295ccba450b">_data_is_stale</a> = <span class="keyword">false</span>; <span class="comment">// status are correctly updated with current waypoint data</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;}</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="comment">// update L1 control for level flight on current heading</span></div><div class="line"><a name="l00487"></a><span class="lineno"><a class="line" href="classAP__L1__Control.html#a5cacc55705a0a4e353f8599e6a0d1910">  487</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classAP__L1__Control.html#a5cacc55705a0a4e353f8599e6a0d1910">AP_L1_Control::update_level_flight</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;{</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    <span class="comment">// copy to _target_bearing_cd and _nav_bearing</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <a class="code" href="classAP__L1__Control.html#aebee3748e799d62f42ab2fbe8afadb9e">_target_bearing_cd</a> = <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a8a160130dd99016a19abab9d85917261">yaw_sensor</a>;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <a class="code" href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">_nav_bearing</a> = <a class="code" href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">_ahrs</a>.<a class="code" href="classAP__AHRS.html#a63359ca9325c63642050bcf1c3e1cd63">yaw</a>;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    <a class="code" href="classAP__L1__Control.html#a2f25d6cea6e98aaec7d7a191537da195">_bearing_error</a> = 0;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <a class="code" href="classAP__L1__Control.html#a077f59318a8244068f1ba9a19831225a">_crosstrack_error</a> = 0;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="comment">// Waypoint capture status is always false during heading hold</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <a class="code" href="classAP__L1__Control.html#a39ccead440555e0e4abc52ab71e9fac8">_WPcircle</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <a class="code" href="classAP__L1__Control.html#a62654b078823ca555139cf64403b5442">_latAccDem</a> = 0;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <a class="code" href="classAP__L1__Control.html#a961307861e61bcbef3147295ccba450b">_data_is_stale</a> = <span class="keyword">false</span>; <span class="comment">// status are correctly updated with current waypoint data</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;}</div><div class="ttc" id="classLocation_html_a48a312dc9de608dda0fe65c5e6f3bf58"><div class="ttname"><a href="classLocation.html#a48a312dc9de608dda0fe65c5e6f3bf58">Location::get_bearing_to</a></div><div class="ttdeci">int32_t get_bearing_to(const struct Location &amp;loc2) const</div><div class="ttdef"><b>Definition:</b> <a href="Location_8cpp_source.html#l00312">Location.cpp:312</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a452628329b2b1c6fd9db864997c71e62"><div class="ttname"><a href="classAP__L1__Control.html#a452628329b2b1c6fd9db864997c71e62">AP_L1_Control::nav_roll_cd</a></div><div class="ttdeci">int32_t nav_roll_cd(void) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00079">AP_L1_Control.cpp:79</a></div></div>
<div class="ttc" id="vector2_8h_html_a9f3739462b0605dcb64299fa289b6afe"><div class="ttname"><a href="vector2_8h.html#a9f3739462b0605dcb64299fa289b6afe">Vector2f</a></div><div class="ttdeci">Vector2&lt; float &gt; Vector2f</div><div class="ttdef"><b>Definition:</b> <a href="vector2_8h_source.html#l00260">vector2.h:260</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a79bf5c44d2e7cd540ff846870593307f"><div class="ttname"><a href="classAP__L1__Control.html#a79bf5c44d2e7cd540ff846870593307f">AP_L1_Control::_last_update_waypoint_us</a></div><div class="ttdeci">uint32_t _last_update_waypoint_us</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00124">AP_L1_Control.h:124</a></div></div>
<div class="ttc" id="definitions_8h_html_a958e4508ed28ee5cc04249144312c15f"><div class="ttname"><a href="definitions_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a></div><div class="ttdeci">#define M_PI_2</div><div class="ttdef"><b>Definition:</b> <a href="definitions_8h_source.html#l00015">definitions.h:15</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a5cacc55705a0a4e353f8599e6a0d1910"><div class="ttname"><a href="classAP__L1__Control.html#a5cacc55705a0a4e353f8599e6a0d1910">AP_L1_Control::update_level_flight</a></div><div class="ttdeci">void update_level_flight(void) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00487">AP_L1_Control.cpp:487</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_ac558013977299a03d6c8cdd61559561d"><div class="ttname"><a href="classAP__L1__Control.html#ac558013977299a03d6c8cdd61559561d">AP_L1_Control::get_yaw_sensor</a></div><div class="ttdeci">float get_yaw_sensor()</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00067">AP_L1_Control.cpp:67</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a0c79e0485a59960ebe5980e121374b0d"><div class="ttname"><a href="classAP__L1__Control.html#a0c79e0485a59960ebe5980e121374b0d">AP_L1_Control::_ahrs</a></div><div class="ttdeci">AP_AHRS &amp; _ahrs</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00081">AP_L1_Control.h:81</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a39ccead440555e0e4abc52ab71e9fac8"><div class="ttname"><a href="classAP__L1__Control.html#a39ccead440555e0e4abc52ab71e9fac8">AP_L1_Control::_WPcircle</a></div><div class="ttdeci">bool _WPcircle</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00094">AP_L1_Control.h:94</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a74021d6b9cf1c7df17624b0a28ae0d7c"><div class="ttname"><a href="classAP__L1__Control.html#a74021d6b9cf1c7df17624b0a28ae0d7c">AP_L1_Control::_L1_xtrack_i</a></div><div class="ttdeci">float _L1_xtrack_i</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00121">AP_L1_Control.h:121</a></div></div>
<div class="ttc" id="AP__HAL_8h_html"><div class="ttname"><a href="AP__HAL_8h.html">AP_HAL.h</a></div></div>
<div class="ttc" id="classAP__AHRS_html_a861802533d7f8a91efc39425ac9c724f"><div class="ttname"><a href="classAP__AHRS.html#a861802533d7f8a91efc39425ac9c724f">AP_AHRS::get_position</a></div><div class="ttdeci">virtual bool get_position(struct Location &amp;loc) const =0</div></div>
<div class="ttc" id="AP__Math_8h_html_a321a91de43cfb2e95d40cde314d0a80f"><div class="ttname"><a href="AP__Math_8h.html#a321a91de43cfb2e95d40cde314d0a80f">MIN</a></div><div class="ttdeci">static auto MIN(const A &amp;one, const B &amp;two) -&gt; decltype(one&lt; two ? one :two)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00202">AP_Math.h:202</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a763a962db3c7a199ee9d3fcd7f42e1ff"><div class="ttname"><a href="classAP__L1__Control.html#a763a962db3c7a199ee9d3fcd7f42e1ff">AP_L1_Control::nav_bearing_cd</a></div><div class="ttdeci">int32_t nav_bearing_cd(void) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00096">AP_L1_Control.cpp:96</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a97f55d73419c935ac0d63c29e288070f"><div class="ttname"><a href="classAP__L1__Control.html#a97f55d73419c935ac0d63c29e288070f">AP_L1_Control::_nav_bearing</a></div><div class="ttdeci">float _nav_bearing</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00097">AP_L1_Control.h:97</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a1a7687ed13c74f535087c984968a92a3"><div class="ttname"><a href="classAP__L1__Control.html#a1a7687ed13c74f535087c984968a92a3">AP_L1_Control::update_heading_hold</a></div><div class="ttdeci">void update_heading_hold(int32_t navigation_heading_cd) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00446">AP_L1_Control.cpp:446</a></div></div>
<div class="ttc" id="AP__Param_8h_html_a78a408c84f2a1bafde256ac650142e4d"><div class="ttname"><a href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a></div><div class="ttdeci">#define AP_GROUPINFO(name, idx, clazz, element, def)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00100">AP_Param.h:100</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a62654b078823ca555139cf64403b5442"><div class="ttname"><a href="classAP__L1__Control.html#a62654b078823ca555139cf64403b5442">AP_L1_Control::_latAccDem</a></div><div class="ttdeci">float _latAccDem</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00088">AP_L1_Control.h:88</a></div></div>
<div class="ttc" id="classAP__AHRS_html_a2aa61744614d8e0ef64803583359a56e"><div class="ttname"><a href="classAP__AHRS.html#a2aa61744614d8e0ef64803583359a56e">AP_AHRS::pitch</a></div><div class="ttdeci">float pitch</div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS_8h_source.html#l00221">AP_AHRS.h:221</a></div></div>
<div class="ttc" id="classAP__AHRS_html_a63359ca9325c63642050bcf1c3e1cd63"><div class="ttname"><a href="classAP__AHRS.html#a63359ca9325c63642050bcf1c3e1cd63">AP_AHRS::yaw</a></div><div class="ttdeci">float yaw</div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS_8h_source.html#l00222">AP_AHRS.h:222</a></div></div>
<div class="ttc" id="AP__Math_8cpp_html_a4e136782e86e2adaaf7f0f759067dfe1"><div class="ttname"><a href="AP__Math_8cpp.html#a4e136782e86e2adaaf7f0f759067dfe1">wrap_180_cd</a></div><div class="ttdeci">auto wrap_180_cd(const T angle) -&gt; decltype(wrap_180(angle, 100.f))</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8cpp_source.html#l00142">AP_Math.cpp:142</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a960b675b15f9850e1ba8d9c878e972bc"><div class="ttname"><a href="classAP__L1__Control.html#a960b675b15f9850e1ba8d9c878e972bc">AP_L1_Control::reached_loiter_target</a></div><div class="ttdeci">bool reached_loiter_target(void) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00172">AP_L1_Control.cpp:172</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a45e259577f46c8cdfe5f52bece257019"><div class="ttname"><a href="classAP__L1__Control.html#a45e259577f46c8cdfe5f52bece257019">AP_L1_Control::_L1_xtrack_i_gain</a></div><div class="ttdeci">AP_Float _L1_xtrack_i_gain</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00122">AP_L1_Control.h:122</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a56dece11a108acd6b733efb497a614f5"><div class="ttname"><a href="classAP__L1__Control.html#a56dece11a108acd6b733efb497a614f5">AP_L1_Control::_L1_period</a></div><div class="ttdeci">AP_Float _L1_period</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00109">AP_L1_Control.h:109</a></div></div>
<div class="ttc" id="structVector2_html_aa78ff4778f55bf9c1ba9a10830fc0b89"><div class="ttname"><a href="structVector2.html#aa78ff4778f55bf9c1ba9a10830fc0b89">Vector2::normalized</a></div><div class="ttdeci">Vector2&lt; T &gt; normalized() const</div><div class="ttdef"><b>Definition:</b> <a href="vector2_8cpp_source.html#l00260">vector2.cpp:260</a></div></div>
<div class="ttc" id="classAP__AHRS_html_aa2fd48ce0265df723cc8d05bb2150749"><div class="ttname"><a href="classAP__AHRS.html#aa2fd48ce0265df723cc8d05bb2150749">AP_AHRS::groundspeed_vector</a></div><div class="ttdeci">virtual Vector2f groundspeed_vector(void)</div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS_8cpp_source.html#l00248">AP_AHRS.cpp:248</a></div></div>
<div class="ttc" id="AP__L1__Control_8cpp_html_ae08c3ca4ba26b63cda0bb3e3c6c02785"><div class="ttname"><a href="AP__L1__Control_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a></div><div class="ttdeci">const AP_HAL::HAL &amp; hal</div><div class="ttdef"><b>Definition:</b> <a href="AC__PID__test_8cpp_source.html#l00021">AC_PID_test.cpp:21</a></div></div>
<div class="ttc" id="classAP__L1__Control_html"><div class="ttname"><a href="classAP__L1__Control.html">AP_L1_Control</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00023">AP_L1_Control.h:23</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a5abc8871f1e7781a55afe9bf299f0a39"><div class="ttname"><a href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a></div><div class="ttdeci">static auto MAX(const A &amp;one, const B &amp;two) -&gt; decltype(one &gt; two ? one :two)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00208">AP_Math.h:208</a></div></div>
<div class="ttc" id="definitions_8h_html_a96799f9de58a211f6b3bdc96c6e10669"><div class="ttname"><a href="definitions_8h.html#a96799f9de58a211f6b3bdc96c6e10669">RadiansToCentiDegrees</a></div><div class="ttdeci">#define RadiansToCentiDegrees(x)</div><div class="ttdef"><b>Definition:</b> <a href="definitions_8h_source.html#l00044">definitions.h:44</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a2f25d6cea6e98aaec7d7a191537da195"><div class="ttname"><a href="classAP__L1__Control.html#a2f25d6cea6e98aaec7d7a191537da195">AP_L1_Control::_bearing_error</a></div><div class="ttdeci">float _bearing_error</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00100">AP_L1_Control.h:100</a></div></div>
<div class="ttc" id="structVector2_html_a6cfed8355591aa269f4dba43bd806ef9"><div class="ttname"><a href="structVector2.html#a6cfed8355591aa269f4dba43bd806ef9">Vector2::y</a></div><div class="ttdeci">T y</div><div class="ttdef"><b>Definition:</b> <a href="vector2_8h_source.html#l00037">vector2.h:37</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a961307861e61bcbef3147295ccba450b"><div class="ttname"><a href="classAP__L1__Control.html#a961307861e61bcbef3147295ccba450b">AP_L1_Control::_data_is_stale</a></div><div class="ttdeci">bool _data_is_stale</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00125">AP_L1_Control.h:125</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_af4402fcd7040bd1779f88cec082cbe36"><div class="ttname"><a href="classAP__L1__Control.html#af4402fcd7040bd1779f88cec082cbe36">AP_L1_Control::_spdHgtControl</a></div><div class="ttdeci">const AP_SpdHgtControl * _spdHgtControl</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00084">AP_L1_Control.h:84</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_ab99bfec3eb21aa7b9dc1edef4cc60fc0"><div class="ttname"><a href="classAP__L1__Control.html#ab99bfec3eb21aa7b9dc1edef4cc60fc0">AP_L1_Control::turn_distance</a></div><div class="ttdeci">float turn_distance(float wp_radius) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00114">AP_L1_Control.cpp:114</a></div></div>
<div class="ttc" id="classAP__HAL_1_1HAL_html"><div class="ttname"><a href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a></div><div class="ttdef"><b>Definition:</b> <a href="HAL_8h_source.html#l00021">HAL.h:21</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a5f64f08c05c9152ff92202150b9ce05e"><div class="ttname"><a href="classAP__L1__Control.html#a5f64f08c05c9152ff92202150b9ce05e">AP_L1_Control::_L1_damping</a></div><div class="ttdeci">AP_Float _L1_damping</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00111">AP_L1_Control.h:111</a></div></div>
<div class="ttc" id="AP__Math_8cpp_html_a21d0562d7b23dd9f04bc30a3611cc577"><div class="ttname"><a href="AP__Math_8cpp.html#a21d0562d7b23dd9f04bc30a3611cc577">wrap_PI</a></div><div class="ttdeci">float wrap_PI(const T radian)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8cpp_source.html#l00183">AP_Math.cpp:183</a></div></div>
<div class="ttc" id="definitions_8h_html_aea8758bf61b23b46507902b46060ebfd"><div class="ttname"><a href="definitions_8h.html#aea8758bf61b23b46507902b46060ebfd">GRAVITY_MSS</a></div><div class="ttdeci">#define GRAVITY_MSS</div><div class="ttdef"><b>Definition:</b> <a href="definitions_8h_source.html#l00047">definitions.h:47</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a2a12cce483e9b870da70d30406d82c60"><div class="ttname"><a href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a></div><div class="ttdeci">bool is_zero(const T fVal1)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00040">AP_Math.h:40</a></div></div>
<div class="ttc" id="DerivativeFilter_8cpp_html_a357394e0f6f88c8a57bd893ab28dc8f8"><div class="ttname"><a href="DerivativeFilter_8cpp.html#a357394e0f6f88c8a57bd893ab28dc8f8">f</a></div><div class="ttdeci">#define f(i)</div></div>
<div class="ttc" id="classLocation_html_af597420e2ec20fc794ca3d5447fd36ba"><div class="ttname"><a href="classLocation.html#af597420e2ec20fc794ca3d5447fd36ba">Location::get_distance_NE</a></div><div class="ttdeci">Vector2f get_distance_NE(const Location &amp;loc2) const</div><div class="ttdef"><b>Definition:</b> <a href="Location_8cpp_source.html#l00231">Location.cpp:231</a></div></div>
<div class="ttc" id="structVector2_html"><div class="ttname"><a href="structVector2.html">Vector2&lt; float &gt;</a></div></div>
<div class="ttc" id="structAP__Param_1_1GroupInfo_html"><div class="ttname"><a href="structAP__Param_1_1GroupInfo.html">AP_Param::GroupInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00142">AP_Param.h:142</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a34f586604201ae335fe7e3d06f5a1fc4"><div class="ttname"><a href="classAP__L1__Control.html#a34f586604201ae335fe7e3d06f5a1fc4">AP_L1_Control::lateral_acceleration</a></div><div class="ttdeci">float lateral_acceleration(void) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00091">AP_L1_Control.cpp:91</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a63005fc8c6746ac5282521d393cbb7f2"><div class="ttname"><a href="classAP__L1__Control.html#a63005fc8c6746ac5282521d393cbb7f2">AP_L1_Control::_L1_dist</a></div><div class="ttdeci">float _L1_dist</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00091">AP_L1_Control.h:91</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a0c6970cc071d4843f0fe983003cc1410"><div class="ttname"><a href="classAP__L1__Control.html#a0c6970cc071d4843f0fe983003cc1410">AP_L1_Control::target_bearing_cd</a></div><div class="ttdeci">int32_t target_bearing_cd(void) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00106">AP_L1_Control.cpp:106</a></div></div>
<div class="ttc" id="AP__Param_8h_html_a752a6a1d27589c64a386ab2818e7057d"><div class="ttname"><a href="AP__Param_8h.html#a752a6a1d27589c64a386ab2818e7057d">AP_GROUPINFO_FRAME</a></div><div class="ttdeci">#define AP_GROUPINFO_FRAME(name, idx, clazz, element, def, frame_flags)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00094">AP_Param.h:94</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a077f59318a8244068f1ba9a19831225a"><div class="ttname"><a href="classAP__L1__Control.html#a077f59318a8244068f1ba9a19831225a">AP_L1_Control::_crosstrack_error</a></div><div class="ttdeci">float _crosstrack_error</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00103">AP_L1_Control.h:103</a></div></div>
<div class="ttc" id="structVector2_html_a671d712528ea3b2cc21fd4616eea8f98"><div class="ttname"><a href="structVector2.html#a671d712528ea3b2cc21fd4616eea8f98">Vector2::length</a></div><div class="ttdeci">float length(void) const</div><div class="ttdef"><b>Definition:</b> <a href="vector2_8cpp_source.html#l00030">vector2.cpp:30</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a6fc833f318b2ababaa0cf52738c71163"><div class="ttname"><a href="classAP__L1__Control.html#a6fc833f318b2ababaa0cf52738c71163">AP_L1_Control::update_loiter</a></div><div class="ttdeci">void update_loiter(const struct Location &amp;center_WP, float radius, int8_t loiter_direction) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00333">AP_L1_Control.cpp:333</a></div></div>
<div class="ttc" id="AP__Math_8h_html_ad525609d9dba6ffa556a0fbf08a3f9b4"><div class="ttname"><a href="AP__Math_8h.html#ad525609d9dba6ffa556a0fbf08a3f9b4">constrain_float</a></div><div class="ttdeci">float constrain_float(const float amt, const float low, const float high)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00142">AP_Math.h:142</a></div></div>
<div class="ttc" id="structVector2_html_a78fa1f2ed5e261c7fbeb8f3536a1ee34"><div class="ttname"><a href="structVector2.html#a78fa1f2ed5e261c7fbeb8f3536a1ee34">Vector2::x</a></div><div class="ttdeci">T x</div><div class="ttdef"><b>Definition:</b> <a href="vector2_8h_source.html#l00037">vector2.h:37</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_aebee3748e799d62f42ab2fbe8afadb9e"><div class="ttname"><a href="classAP__L1__Control.html#aebee3748e799d62f42ab2fbe8afadb9e">AP_L1_Control::_target_bearing_cd</a></div><div class="ttdeci">int32_t _target_bearing_cd</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00106">AP_L1_Control.h:106</a></div></div>
<div class="ttc" id="AP__Math_8cpp_html_accbd9f8bbc0adacd51efa66fad490c24"><div class="ttname"><a href="AP__Math_8cpp.html#accbd9f8bbc0adacd51efa66fad490c24">is_equal</a></div><div class="ttdeci">std::enable_if&lt; std::is_integral&lt; typename std::common_type&lt; Arithmetic1, Arithmetic2 &gt;::type &gt;::value,bool &gt;::type is_equal(const Arithmetic1 v_1, const Arithmetic2 v_2)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8cpp_source.html#l00014">AP_Math.cpp:14</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a37d7c62a8231d9d22826261297b99da4"><div class="ttname"><a href="AP__Math_8h.html#a37d7c62a8231d9d22826261297b99da4">radians</a></div><div class="ttdeci">static constexpr float radians(float deg)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00163">AP_Math.h:163</a></div></div>
<div class="ttc" id="structVector2_html_ace2a626eaa79412e2946216e9c3e63c6"><div class="ttname"><a href="structVector2.html#ace2a626eaa79412e2946216e9c3e63c6">Vector2::normalize</a></div><div class="ttdeci">void normalize()</div><div class="ttdef"><b>Definition:</b> <a href="vector2_8cpp_source.html#l00253">vector2.cpp:253</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_aa80fb1f9f7ca34cd3da895ab4e9b4436"><div class="ttname"><a href="classAP__L1__Control.html#aa80fb1f9f7ca34cd3da895ab4e9b4436">AP_L1_Control::var_info</a></div><div class="ttdeci">static const struct AP_Param::GroupInfo var_info[]</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00073">AP_L1_Control.h:73</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_ab80fcf9f4408e4c3a70af6fa89da20d3"><div class="ttname"><a href="classAP__L1__Control.html#ab80fcf9f4408e4c3a70af6fa89da20d3">AP_L1_Control::get_yaw</a></div><div class="ttdeci">float get_yaw()</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00056">AP_L1_Control.cpp:56</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a41a8ab916024b77959ed059dd12469a1"><div class="ttname"><a href="classAP__L1__Control.html#a41a8ab916024b77959ed059dd12469a1">AP_L1_Control::bearing_error_cd</a></div><div class="ttdeci">int32_t bearing_error_cd(void) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00101">AP_L1_Control.cpp:101</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a2f30082f502f02b94d754c6bb735f70b"><div class="ttname"><a href="classAP__L1__Control.html#a2f30082f502f02b94d754c6bb735f70b">AP_L1_Control::loiter_radius</a></div><div class="ttdeci">float loiter_radius(const float loiter_radius) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00138">AP_L1_Control.cpp:138</a></div></div>
<div class="ttc" id="AP__Param_8h_html_a5def49b63b71690b19ea5a19ee3b4788"><div class="ttname"><a href="AP__Param_8h.html#a5def49b63b71690b19ea5a19ee3b4788">AP_PARAM_FRAME_PLANE</a></div><div class="ttdeci">#define AP_PARAM_FRAME_PLANE</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00077">AP_Param.h:77</a></div></div>
<div class="ttc" id="AP__L1__Control_8h_html"><div class="ttname"><a href="AP__L1__Control_8h.html">AP_L1_Control.h</a></div><div class="ttdoc">L1 Control algorithm. This is a instance of an AP_Navigation class.</div></div>
<div class="ttc" id="classAP__L1__Control_html_a694095425105d37dd52aeb275925f6d7"><div class="ttname"><a href="classAP__L1__Control.html#a694095425105d37dd52aeb275925f6d7">AP_L1_Control::_loiter_bank_limit</a></div><div class="ttdeci">AP_Float _loiter_bank_limit</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00127">AP_L1_Control.h:127</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_aaa154ba9c5957f90785c34ee554eca1c"><div class="ttname"><a href="classAP__L1__Control.html#aaa154ba9c5957f90785c34ee554eca1c">AP_L1_Control::_prevent_indecision</a></div><div class="ttdeci">void _prevent_indecision(float &amp;Nu)</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00182">AP_L1_Control.cpp:182</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a0375e3d67fd3911cacee5c3e1408c0f2"><div class="ttname"><a href="AP__Math_8h.html#a0375e3d67fd3911cacee5c3e1408c0f2">sq</a></div><div class="ttdeci">float sq(const T val)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00175">AP_Math.h:175</a></div></div>
<div class="ttc" id="classAP__SpdHgtControl_html_aef400289c2cdf6c24d39f3c93b82df37"><div class="ttname"><a href="classAP__SpdHgtControl.html#aef400289c2cdf6c24d39f3c93b82df37">AP_SpdHgtControl::get_target_airspeed</a></div><div class="ttdeci">virtual float get_target_airspeed(void) const =0</div></div>
<div class="ttc" id="classAP__AHRS_html_a64786b58a1607ee420ed4f0696c755b6"><div class="ttname"><a href="classAP__AHRS.html#a64786b58a1607ee420ed4f0696c755b6">AP_AHRS::get_EAS2TAS</a></div><div class="ttdeci">float get_EAS2TAS(void) const</div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS_8cpp_source.html#l00508">AP_AHRS.cpp:508</a></div></div>
<div class="ttc" id="moduletest_8c_html_a903c4797a4c2860e3b9a6a978f98a44d"><div class="ttname"><a href="moduletest_8c.html#a903c4797a4c2860e3b9a6a978f98a44d">degrees</a></div><div class="ttdeci">#define degrees(x)</div><div class="ttdef"><b>Definition:</b> <a href="moduletest_8c_source.html#l00023">moduletest.c:23</a></div></div>
<div class="ttc" id="definitions_8h_html_ae71449b1cc6e6250b91f539153a7a0d3"><div class="ttname"><a href="definitions_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a></div><div class="ttdeci">#define M_PI</div><div class="ttdef"><b>Definition:</b> <a href="definitions_8h_source.html#l00010">definitions.h:10</a></div></div>
<div class="ttc" id="classLocation_html"><div class="ttname"><a href="classLocation.html">Location</a></div><div class="ttdef"><b>Definition:</b> <a href="Location_8h_source.html#l00009">Location.h:9</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a725b90895d4de350044edbe07ed38613"><div class="ttname"><a href="classAP__L1__Control.html#a725b90895d4de350044edbe07ed38613">AP_L1_Control::_L1_xtrack_i_gain_prev</a></div><div class="ttdeci">float _L1_xtrack_i_gain_prev</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00123">AP_L1_Control.h:123</a></div></div>
<div class="ttc" id="classAP__AHRS_html_a8a160130dd99016a19abab9d85917261"><div class="ttname"><a href="classAP__AHRS.html#a8a160130dd99016a19abab9d85917261">AP_AHRS::yaw_sensor</a></div><div class="ttdeci">int32_t yaw_sensor</div><div class="ttdef"><b>Definition:</b> <a href="AP__AHRS_8h_source.html#l00227">AP_AHRS.h:227</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a545690fe6188ee32805f5e33cc3da1bc"><div class="ttname"><a href="classAP__L1__Control.html#a545690fe6188ee32805f5e33cc3da1bc">AP_L1_Control::update_waypoint</a></div><div class="ttdeci">void update_waypoint(const struct Location &amp;prev_WP, const struct Location &amp;next_WP, float dist_min=0.0f) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8cpp_source.html#l00198">AP_L1_Control.cpp:198</a></div></div>
<div class="ttc" id="namespaceAP__HAL_html_a8293355e35887733b1fd151aef08a787"><div class="ttname"><a href="namespaceAP__HAL.html#a8293355e35887733b1fd151aef08a787">AP_HAL::micros</a></div><div class="ttdeci">uint32_t micros()</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2system_8cpp_source.html#l00152">system.cpp:152</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a67c543ed97304d5d11433f83d4f53280"><div class="ttname"><a href="classAP__L1__Control.html#a67c543ed97304d5d11433f83d4f53280">AP_L1_Control::_last_Nu</a></div><div class="ttdeci">float _last_Nu</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00114">AP_L1_Control.h:114</a></div></div>
<div class="ttc" id="AP__Param_8h_html_a0f9acb038a5283b964b862aea8cc5051"><div class="ttname"><a href="AP__Param_8h.html#a0f9acb038a5283b964b862aea8cc5051">AP_GROUPEND</a></div><div class="ttdeci">#define AP_GROUPEND</div><div class="ttdef"><b>Definition:</b> <a href="AP__Param_8h_source.html#l00118">AP_Param.h:118</a></div></div>
<div class="ttc" id="classAP__L1__Control_html_a9290bef1192d5649fa929e1feefe21da"><div class="ttname"><a href="classAP__L1__Control.html#a9290bef1192d5649fa929e1feefe21da">AP_L1_Control::_reverse</a></div><div class="ttdeci">bool _reverse</div><div class="ttdef"><b>Definition:</b> <a href="AP__L1__Control_8h_source.html#l00129">AP_L1_Control.h:129</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Jul 11 2019 14:17:30 for APM:Libraries by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>

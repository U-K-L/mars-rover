<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>APM:Libraries: libraries/AP_HAL_ChibiOS/I2CDevice.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">APM:Libraries
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_bc0718b08fb2015b8e59c47b2805f60c.html">libraries</a></li><li class="navelem"><a class="el" href="dir_498c8457c5f0ddd4ec603971505dced8.html">AP_HAL_ChibiOS</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">I2CDevice.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * This file is free software: you can redistribute it and/or modify it</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * under the terms of the GNU General Public License as published by the</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * Free Software Foundation, either version 3 of the License, or</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * (at your option) any later version.</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * This file is distributed in the hope that it will be useful, but</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * See the GNU General Public License for more details.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * You should have received a copy of the GNU General Public License along</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ChibiOS_2I2CDevice_8h.html">I2CDevice.h</a>&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="AP__HAL_8h.html">AP_HAL/AP_HAL.h</a>&gt;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="AP__Math_8h.html">AP_Math/AP_Math.h</a>&gt;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ChibiOS_2Util_8h.html">Util.h</a>&quot;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#if HAL_USE_I2C == TRUE</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ChibiOS_2Scheduler_8h.html">Scheduler.h</a>&quot;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="stm32__util_8h.html">hwdef/common/stm32_util.h</a>&quot;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;ch.h&quot;</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;hal.h&quot;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno"><a class="line" href="structI2CInfo.html">   29</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structI2CInfo.html">I2CInfo</a> {</div><div class="line"><a name="l00030"></a><span class="lineno"><a class="line" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">   30</a></span>&#160;    <span class="keyword">struct </span>I2CDriver *<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>;</div><div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="structI2CInfo.html#a86b185023febb72e80bb3a093a68956d">   31</a></span>&#160;    uint8_t <a class="code" href="structI2CInfo.html#a86b185023febb72e80bb3a093a68956d">dma_channel_rx</a>;</div><div class="line"><a name="l00032"></a><span class="lineno"><a class="line" href="structI2CInfo.html#a166839b391b41faeefcad8284b5012e8">   32</a></span>&#160;    uint8_t <a class="code" href="structI2CInfo.html#a166839b391b41faeefcad8284b5012e8">dma_channel_tx</a>;</div><div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="structI2CInfo.html#a112cbfb7c93d72b5f5af36e06f3a7cc1">   33</a></span>&#160;    ioline_t <a class="code" href="structI2CInfo.html#a112cbfb7c93d72b5f5af36e06f3a7cc1">scl_line</a>;</div><div class="line"><a name="l00034"></a><span class="lineno"><a class="line" href="structI2CInfo.html#aba869fbc255486788b2f7b3abc9586bb">   34</a></span>&#160;    ioline_t <a class="code" href="structI2CInfo.html#aba869fbc255486788b2f7b3abc9586bb">sda_line</a>;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;} <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[] = { HAL_I2C_DEVICE_LIST };</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespaceChibiOS.html">ChibiOS</a>;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">extern</span> <span class="keyword">const</span> <a class="code" href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a>&amp; <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a>;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<a class="code" href="classChibiOS_1_1I2CBus.html">I2CBus</a> <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">I2CDeviceManager::businfo</a>[<a class="code" href="AP__Common_8h.html#a121caf32c5b5d704ef3453f0885a9ea5">ARRAY_SIZE</a>(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>)];</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#ifndef HAL_I2C_BUS_BASE</span></div><div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#aa3a1fa01d8ad08cd740c710b0093451e">   43</a></span>&#160;<span class="preprocessor">#define HAL_I2C_BUS_BASE 0</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">// default to 100kHz clock for maximum reliability. This can be</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">// changed in hwdef.dat</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#ifndef HAL_I2C_MAX_CLOCK</span></div><div class="line"><a name="l00049"></a><span class="lineno"><a class="line" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac0bae386fcc29b708566d7682b47b276">   49</a></span>&#160;<span class="preprocessor">#define HAL_I2C_MAX_CLOCK 100000</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">// values calculated with STM32CubeMX tool, PCLK=54MHz</span></div><div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#a184fb530485402da7e21c274855b0436">   53</a></span>&#160;<span class="preprocessor">#define HAL_I2C_F7_100_TIMINGR 0x20404768</span></div><div class="line"><a name="l00054"></a><span class="lineno"><a class="line" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#a66ed6e2c22eca428363d38855df34402">   54</a></span>&#160;<span class="preprocessor">#define HAL_I2C_F7_400_TIMINGR 0x6000030D</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">  enable clear (toggling SCL) on I2C bus timeouts which leave SDA stuck low</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#ifndef HAL_I2C_CLEAR_ON_TIMEOUT</span></div><div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ab0bc70ffce235a6ed1bd1546096994c1">   60</a></span>&#160;<span class="preprocessor">#define HAL_I2C_CLEAR_ON_TIMEOUT 1</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">// get a handle for DMA sharing DMA channels with other subsystems</span></div><div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CBus.html#a35c56dc7197d08e6e3dceaede80c3bda">   64</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChibiOS_1_1I2CBus.html#a35c56dc7197d08e6e3dceaede80c3bda">I2CBus::dma_init</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;{</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    chMtxObjectInit(&amp;<a class="code" href="classChibiOS_1_1I2CBus.html#ac124e37d9964ffb269dce287c040146d">dma_lock</a>);</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <a class="code" href="classChibiOS_1_1DeviceBus.html#a5e916b7cbe184547b8a9521f56ea3104">dma_handle</a> = <span class="keyword">new</span> Shared_DMA(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].dma_channel_tx, <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].dma_channel_rx, </div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;                                <a class="code" href="functor_8h.html#a00e5874203cecc310017f9166f2c0e36">FUNCTOR_BIND_MEMBER</a>(&amp;<a class="code" href="classChibiOS_1_1I2CBus.html#a9174696454e25295edb89aac743e95b2">I2CBus::dma_allocate</a>, <span class="keywordtype">void</span>, Shared_DMA *),</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                                <a class="code" href="functor_8h.html#a00e5874203cecc310017f9166f2c0e36">FUNCTOR_BIND_MEMBER</a>(&amp;<a class="code" href="classChibiOS_1_1I2CBus.html#a3f542c806f81e1a334ccd03b7c87c7b6">I2CBus::dma_deallocate</a>, <span class="keywordtype">void</span>, Shared_DMA *));    </div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;}</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">// Clear Bus to avoid bus lockup</span></div><div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CBus.html#aab8555f70bcaceb49f6d26f92a8b3af6">   73</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChibiOS_1_1I2CBus.html#aab8555f70bcaceb49f6d26f92a8b3af6">I2CBus::clear_all</a>()</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;{</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keywordflow">for</span> (uint8_t i=0; i&lt;<a class="code" href="AP__Common_8h.html#a121caf32c5b5d704ef3453f0885a9ea5">ARRAY_SIZE</a>(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>); i++) {</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <a class="code" href="classChibiOS_1_1I2CBus.html#a2170a7c8dc425809db682bed380abd4f">clear_bus</a>(i);</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    }</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;}</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">  clear a stuck bus (bus held by a device that is holding SDA low) by</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">  clocking out pulses on SCL to let the device complete its</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">  transaction</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00085"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CBus.html#a2170a7c8dc425809db682bed380abd4f">   85</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChibiOS_1_1I2CBus.html#a2170a7c8dc425809db682bed380abd4f">I2CBus::clear_bus</a>(uint8_t busidx)</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;{</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structI2CInfo.html">I2CInfo</a> &amp;info = <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[busidx];</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="keyword">const</span> iomode_t mode_saved = palReadLineMode(info.<a class="code" href="structI2CInfo.html#a112cbfb7c93d72b5f5af36e06f3a7cc1">scl_line</a>);</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    palSetLineMode(info.<a class="code" href="structI2CInfo.html#a112cbfb7c93d72b5f5af36e06f3a7cc1">scl_line</a>, PAL_MODE_OUTPUT_PUSHPULL);</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="keywordflow">for</span>(uint8_t j = 0; j &lt; 20; j++) {</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        palToggleLine(info.<a class="code" href="structI2CInfo.html#a112cbfb7c93d72b5f5af36e06f3a7cc1">scl_line</a>);</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a>.<a class="code" href="classAP__HAL_1_1HAL.html#a94ab41309b1ff10b8b862b826e59c882">scheduler</a>-&gt;<a class="code" href="classAP__HAL_1_1Scheduler.html#a78c4f1b1f192ac1c99544b6cc8f099b0">delay_microseconds</a>(10);</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    }</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    palSetLineMode(info.<a class="code" href="structI2CInfo.html#a112cbfb7c93d72b5f5af36e06f3a7cc1">scl_line</a>, mode_saved);</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;}</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">  read SDA on a bus, to check if it may be stuck</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00100"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CBus.html#a0bae064bcf2539888a94b2310e453f90">  100</a></span>&#160;uint8_t <a class="code" href="classChibiOS_1_1I2CBus.html#a0bae064bcf2539888a94b2310e453f90">I2CBus::read_sda</a>(uint8_t busidx)</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;{</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structI2CInfo.html">I2CInfo</a> &amp;info = <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[busidx];</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keyword">const</span> iomode_t mode_saved = palReadLineMode(info.<a class="code" href="structI2CInfo.html#aba869fbc255486788b2f7b3abc9586bb">sda_line</a>);</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    palSetLineMode(info.<a class="code" href="structI2CInfo.html#aba869fbc255486788b2f7b3abc9586bb">sda_line</a>, PAL_MODE_INPUT);</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    uint8_t ret = palReadLine(info.<a class="code" href="structI2CInfo.html#aba869fbc255486788b2f7b3abc9586bb">sda_line</a>);</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    palSetLineMode(info.<a class="code" href="structI2CInfo.html#aba869fbc255486788b2f7b3abc9586bb">sda_line</a>, mode_saved);</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;}</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">// setup I2C buses</span></div><div class="line"><a name="l00111"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDeviceManager.html#ae339d9be7bdce3f514b74f99ae879dfa">  111</a></span>&#160;<a class="code" href="classChibiOS_1_1I2CDeviceManager.html#ae339d9be7bdce3f514b74f99ae879dfa">I2CDeviceManager::I2CDeviceManager</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;{</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="keywordflow">for</span> (uint8_t i=0; i&lt;<a class="code" href="AP__Common_8h.html#a121caf32c5b5d704ef3453f0885a9ea5">ARRAY_SIZE</a>(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>); i++) {</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a> = i;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a35c56dc7197d08e6e3dceaede80c3bda">dma_init</a>();</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">          setup default I2C config. As each device is opened we will</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">          drop the speed to be the minimum speed requested</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a> = <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac0bae386fcc29b708566d7682b47b276">HAL_I2C_MAX_CLOCK</a>;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="preprocessor">#if defined(STM32F7) || defined(STM32H7)</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].busclock &lt;= 100000) {</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.timingr = <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#a184fb530485402da7e21c274855b0436">HAL_I2C_F7_100_TIMINGR</a>;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a> = 100000;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.timingr = <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#a66ed6e2c22eca428363d38855df34402">HAL_I2C_F7_400_TIMINGR</a>;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a> = 400000;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        }</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.op_mode = OPMODE_I2C;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.clock_speed = <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a>;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].i2ccfg.clock_speed &lt;= 100000) {</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.duty_cycle = STD_DUTY_CYCLE;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">businfo</a>[i].<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.duty_cycle = FAST_DUTY_CYCLE_2;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        }</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    }</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;}</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDevice.html#a0e9ae4b92ca5cf17c73339ee87a12062">  141</a></span>&#160;<a class="code" href="classAP__HAL_1_1I2CDevice.html#ac84c9ea3fa0179792f138376516104e1">I2CDevice::I2CDevice</a>(uint8_t busnum, uint8_t address, uint32_t bus_clock, <span class="keywordtype">bool</span> use_smbus, uint32_t timeout_ms) :</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    _retries(2),</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    _address(address),</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    _use_smbus(use_smbus),</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    _timeout_ms(timeout_ms),</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    bus(<a class="code" href="classChibiOS_1_1I2CDeviceManager.html">I2CDeviceManager</a>::businfo[busnum])</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;{</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <a class="code" href="classAP__HAL_1_1Device.html#a5f5d708368bd4779f30377409b56bbca">set_device_bus</a>(busnum+<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#aa3a1fa01d8ad08cd740c710b0093451e">HAL_I2C_BUS_BASE</a>);</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <a class="code" href="classAP__HAL_1_1Device.html#afb5df3da326300740856c48d338d4cf2">set_device_address</a>(address);</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <a class="code" href="stdio_8h.html#a1af9acc6b6efdca3576cb8223d95f401">asprintf</a>(&amp;<a class="code" href="classChibiOS_1_1I2CDevice.html#a4622102073859d0e905ddcd0fc37a08c">pname</a>, <span class="stringliteral">&quot;I2C:%u:%02x&quot;</span>,</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;             (<span class="keywordtype">unsigned</span>)busnum, (<span class="keywordtype">unsigned</span>)address);</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="keywordflow">if</span> (bus_clock &lt; <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a>) {</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="preprocessor">#if defined(STM32F7) || defined(STM32H7)</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <span class="keywordflow">if</span> (bus_clock &lt;= 100000) {</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.timingr = <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#a184fb530485402da7e21c274855b0436">HAL_I2C_F7_100_TIMINGR</a>;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a> = 100000;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        }</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.clock_speed = bus_clock;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a> = bus_clock;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="keywordflow">if</span> (bus_clock &lt;= 100000) {</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.duty_cycle = STD_DUTY_CYCLE;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        }</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a>.<a class="code" href="classAP__HAL_1_1HAL.html#a92168462febe0f5ab9556dc9ea4ddb7a">console</a>-&gt;<a class="code" href="classAP__HAL_1_1BetterStream.html#a8534aa004599bb81ad60f3e762791032">printf</a>(<span class="stringliteral">&quot;I2C%u clock %ukHz\n&quot;</span>, busnum, <span class="keywordtype">unsigned</span>(<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a>/1000));</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    }</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;}</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDevice.html#aebf54d150dca31a5bd8ddd524cb5bb00">  169</a></span>&#160;<a class="code" href="classChibiOS_1_1I2CDevice.html#aebf54d150dca31a5bd8ddd524cb5bb00">I2CDevice::~I2CDevice</a>()</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;{</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="preprocessor">#if 0</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <a class="code" href="stdio_8h.html#a55f3d956bb2ba20b5059e9e25484a47f">printf</a>(<span class="stringliteral">&quot;I2C device bus %u address 0x%02x closed\n&quot;</span>, </div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;           (<span class="keywordtype">unsigned</span>)<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>, (<span class="keywordtype">unsigned</span>)<a class="code" href="classChibiOS_1_1I2CDevice.html#a48f0f37269a9d6b464591e307fbd3335">_address</a>);</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <a class="code" href="malloc_8c.html#afbedc913aa4651b3c3b4b3aecd9b4711">free</a>(<a class="code" href="classChibiOS_1_1I2CDevice.html#a4622102073859d0e905ddcd0fc37a08c">pname</a>);</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;}</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">  allocate DMA channel, nothing to do, as we don&#39;t keep the bus active between transactions</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00181"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CBus.html#a9174696454e25295edb89aac743e95b2">  181</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChibiOS_1_1I2CBus.html#a9174696454e25295edb89aac743e95b2">I2CBus::dma_allocate</a>(Shared_DMA *ctx)</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;{</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;}</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">  deallocate DMA channel</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00188"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CBus.html#a3f542c806f81e1a334ccd03b7c87c7b6">  188</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classChibiOS_1_1I2CBus.html#a3f542c806f81e1a334ccd03b7c87c7b6">I2CBus::dma_deallocate</a>(Shared_DMA *)</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;{</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;}</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDevice.html#acda87a68781e50471e6e8c20a7ec0541">  192</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classChibiOS_1_1I2CDevice.html#acda87a68781e50471e6e8c20a7ec0541">I2CDevice::transfer</a>(<span class="keyword">const</span> uint8_t *send, uint32_t send_len,</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                         uint8_t *recv, uint32_t recv_len)</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;{</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1DeviceBus.html#a29e22a909c9217f9e458d173f96c4655">semaphore</a>.<a class="code" href="classChibiOS_1_1Semaphore.html#a9b3100381eab8d8c7640f4fa5f2fe367">check_owner</a>()) {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a>.<a class="code" href="classAP__HAL_1_1HAL.html#a92168462febe0f5ab9556dc9ea4ddb7a">console</a>-&gt;<a class="code" href="classAP__HAL_1_1BetterStream.html#a8534aa004599bb81ad60f3e762791032">printf</a>(<span class="stringliteral">&quot;I2C: not owner of 0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span>)<a class="code" href="classAP__HAL_1_1Device.html#a51dc074d450d02eedf40229f33d80c16">get_bus_id</a>());</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    }</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    </div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="preprocessor">#if defined(STM32F7) || defined(STM32H7)</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChibiOS_1_1I2CDevice.html#a5ce66a1a3aff0242e164aab35421a450">_use_smbus</a>) {</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.cr1 |= I2C_CR1_SMBHEN;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.cr1 &amp;= ~I2C_CR1_SMBHEN;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    }</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChibiOS_1_1I2CDevice.html#a5ce66a1a3aff0242e164aab35421a450">_use_smbus</a>) {</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.op_mode = OPMODE_SMBUS_HOST;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>.op_mode = OPMODE_I2C;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    }</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classChibiOS_1_1I2CDevice.html#a08c367960abb5b5f19a9eabd27454d6c">_split_transfers</a>) {</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">          splitting the transfer() into two pieces avoids a stop condition</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment">          with SCL low which is not supported on some devices (such as</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">          LidarLite blue label)</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">        */</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="keywordflow">if</span> (send &amp;&amp; send_len) {</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="classChibiOS_1_1I2CDevice.html#a21a03f46d6b4c8d603df4a71a93a65b2">_transfer</a>(send, send_len, <span class="keyword">nullptr</span>, 0)) {</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;            }</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        }</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="keywordflow">if</span> (recv &amp;&amp; recv_len) {</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="classChibiOS_1_1I2CDevice.html#a21a03f46d6b4c8d603df4a71a93a65b2">_transfer</a>(<span class="keyword">nullptr</span>, 0, recv, recv_len)) {</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;            }</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        }</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="comment">// combined transfer</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classChibiOS_1_1I2CDevice.html#a21a03f46d6b4c8d603df4a71a93a65b2">_transfer</a>(send, send_len, recv, recv_len)) {</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        }</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    }</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;}</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDevice.html#a21a03f46d6b4c8d603df4a71a93a65b2">  240</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classChibiOS_1_1I2CDevice.html#a21a03f46d6b4c8d603df4a71a93a65b2">I2CDevice::_transfer</a>(<span class="keyword">const</span> uint8_t *send, uint32_t send_len,</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                         uint8_t *recv, uint32_t recv_len)</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;{</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    i2cAcquireBus(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>);</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1DeviceBus.html#a479b9906ae9f6fc2461b1f0b240dc27f">bouncebuffer_setup</a>(send, send_len, recv, recv_len);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    </div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordflow">for</span>(uint8_t i=0 ; i &lt;= <a class="code" href="classChibiOS_1_1I2CDevice.html#aa267e7620497038a0e3386c3b78e5517">_retries</a>; i++) {</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="keywordtype">int</span> ret;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="comment">// calculate a timeout as twice the expected transfer time, and set as min of 4ms</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        uint32_t timeout_ms = 1+2*(((8*1000000UL/<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">busclock</a>)*<a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>(send_len, recv_len))/1000);</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        timeout_ms = <a class="code" href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a>(timeout_ms, <a class="code" href="classChibiOS_1_1I2CDevice.html#a5d57204892e08123b27539b5826ed5f2">_timeout_ms</a>);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <span class="comment">// we get the lock and start the bus inside the retry loop to</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="comment">// allow us to give up the DMA channel to an SPI device on</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <span class="comment">// retries</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1DeviceBus.html#a5e916b7cbe184547b8a9521f56ea3104">dma_handle</a>-&gt;lock();</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        i2cStart(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>, &amp;<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">i2ccfg</a>);</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        osalDbgAssert(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>-&gt;state == I2C_READY, <span class="stringliteral">&quot;i2cStart state&quot;</span>);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        </div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        osalSysLock();</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a>.<a class="code" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code" href="classAP__HAL_1_1Util.html#a64273fdab59825cea305a403054c25bf">persistent_data</a>.<a class="code" href="structAP__HAL_1_1Util_1_1PersistentData.html#a6fae0db0f91fce53a13ff9e25f74e058">i2c_count</a>++;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        osalSysUnlock();</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        <span class="keywordflow">if</span>(send_len == 0) {</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            ret = i2cMasterReceiveTimeout(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>, <a class="code" href="classChibiOS_1_1I2CDevice.html#a48f0f37269a9d6b464591e307fbd3335">_address</a>, recv, recv_len, chTimeMS2I(timeout_ms));</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            ret = i2cMasterTransmitTimeout(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>, <a class="code" href="classChibiOS_1_1I2CDevice.html#a48f0f37269a9d6b464591e307fbd3335">_address</a>, send, send_len,</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                                           recv, recv_len, chTimeMS2I(timeout_ms));</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        }</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        i2cSoftStop(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>);</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        osalDbgAssert(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>-&gt;state == I2C_STOP, <span class="stringliteral">&quot;i2cStart state&quot;</span>);</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        </div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1DeviceBus.html#a5e916b7cbe184547b8a9521f56ea3104">dma_handle</a>-&gt;unlock();</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        </div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="keywordflow">if</span> (ret == MSG_OK) {</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;            <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1DeviceBus.html#a9cfb645fb170b85b11b6a87463a6ccf9">bouncebuffer_finish</a>(send, recv, recv_len);</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            i2cReleaseBus(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>);</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        }</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor">#if HAL_I2C_CLEAR_ON_TIMEOUT</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        <span class="keywordflow">if</span> (ret == MSG_TIMEOUT &amp;&amp; <a class="code" href="classChibiOS_1_1I2CBus.html#a0bae064bcf2539888a94b2310e453f90">I2CBus::read_sda</a>(<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>) == 0) {</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            <a class="code" href="classChibiOS_1_1I2CBus.html#a2170a7c8dc425809db682bed380abd4f">I2CBus::clear_bus</a>(<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>);</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        }</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    }</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1DeviceBus.html#a9cfb645fb170b85b11b6a87463a6ccf9">bouncebuffer_finish</a>(send, recv, recv_len);</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    i2cReleaseBus(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>[<a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">busnum</a>].<a class="code" href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">i2c</a>);</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;}</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div><div class="line"><a name="l00293"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDevice.html#ab978a5c214ad4abcb89035bab4ce6055">  293</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classChibiOS_1_1I2CDevice.html#ab978a5c214ad4abcb89035bab4ce6055">I2CDevice::read_registers_multiple</a>(uint8_t first_reg, uint8_t *recv,</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                                        uint32_t recv_len, uint8_t times)</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;{</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;}</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    </div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">  register a periodic callback</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00303"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDevice.html#a49868f6cbd67bc4755b33a8c1b7e9f77">  303</a></span>&#160;<a class="code" href="classAP__HAL_1_1Device.html#a93226579e055533dd07379b2cb55ea7e">AP_HAL::Device::PeriodicHandle</a> <a class="code" href="classChibiOS_1_1I2CDevice.html#a49868f6cbd67bc4755b33a8c1b7e9f77">I2CDevice::register_periodic_callback</a>(uint32_t period_usec, AP_HAL::Device::PeriodicCb cb)</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;{</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1DeviceBus.html#ac9b1fc7ac63003c96c79f4ff49f5f0bd">register_periodic_callback</a>(period_usec, cb, <span class="keyword">this</span>);</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;}</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    </div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">  adjust a periodic callback</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00312"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDevice.html#a0ee932744e9baa1fff2a3fe58a0b363b">  312</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classChibiOS_1_1I2CDevice.html#a0ee932744e9baa1fff2a3fe58a0b363b">I2CDevice::adjust_periodic_callback</a>(<a class="code" href="classAP__HAL_1_1Device.html#a93226579e055533dd07379b2cb55ea7e">AP_HAL::Device::PeriodicHandle</a> h, uint32_t period_usec)</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;{</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">bus</a>.<a class="code" href="classChibiOS_1_1DeviceBus.html#adac0a2a450eee9ee70df8c45f9d3bae2">adjust_timer</a>(h, period_usec);</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;}</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<a class="code" href="classAP__HAL_1_1OwnPtr.html">AP_HAL::OwnPtr&lt;AP_HAL::I2CDevice&gt;</a></div><div class="line"><a name="l00318"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDeviceManager.html#ae435ba9feecd3133ef74a72ff5aa85c4">  318</a></span>&#160;<a class="code" href="classChibiOS_1_1I2CDeviceManager.html#ae435ba9feecd3133ef74a72ff5aa85c4">I2CDeviceManager::get_device</a>(uint8_t bus, uint8_t address,</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                             uint32_t bus_clock,</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                             <span class="keywordtype">bool</span> use_smbus,</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                             uint32_t timeout_ms)</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;{</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    bus -= <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#aa3a1fa01d8ad08cd740c710b0093451e">HAL_I2C_BUS_BASE</a>;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordflow">if</span> (bus &gt;= <a class="code" href="AP__Common_8h.html#a121caf32c5b5d704ef3453f0885a9ea5">ARRAY_SIZE</a>(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>)) {</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="classAP__HAL_1_1OwnPtr.html">AP_HAL::OwnPtr&lt;AP_HAL::I2CDevice&gt;</a>(<span class="keyword">nullptr</span>);</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    }</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="keyword">auto</span> <a class="code" href="ICM20789_8cpp.html#a73e56d364aa23cb788be9693c10ef7e9">dev</a> = <a class="code" href="classAP__HAL_1_1OwnPtr.html">AP_HAL::OwnPtr&lt;AP_HAL::I2CDevice&gt;</a>(<span class="keyword">new</span> <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#af896f66bf6ef713752ed0b4acdf2639b">I2CDevice</a>(bus, address, bus_clock, use_smbus, timeout_ms));</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="ICM20789_8cpp.html#a73e56d364aa23cb788be9693c10ef7e9">dev</a>;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;}</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">  get mask of bus numbers for all configured I2C buses</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00334"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDeviceManager.html#ad965b8e3841f7adda788b472d8288a78">  334</a></span>&#160;uint32_t <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#ad965b8e3841f7adda788b472d8288a78">I2CDeviceManager::get_bus_mask</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">return</span> ((1U &lt;&lt; <a class="code" href="AP__Common_8h.html#a121caf32c5b5d704ef3453f0885a9ea5">ARRAY_SIZE</a>(<a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a>)) - 1) &lt;&lt; <a class="code" href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#aa3a1fa01d8ad08cd740c710b0093451e">HAL_I2C_BUS_BASE</a>;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;}</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment">  get mask of bus numbers for all configured internal I2C buses</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00342"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDeviceManager.html#a22a5da06be499ef4519fce386f435626">  342</a></span>&#160;uint32_t <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#a22a5da06be499ef4519fce386f435626">I2CDeviceManager::get_bus_mask_internal</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="comment">// assume first bus is internal</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#ad965b8e3841f7adda788b472d8288a78">get_bus_mask</a>() &amp; <a class="code" href="chibios_8h.html#a92c1036d708a9d3b99a1bf93f35ca71e">HAL_I2C_INTERNAL_MASK</a>;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;}</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">  get mask of bus numbers for all configured external I2C buses</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00351"></a><span class="lineno"><a class="line" href="classChibiOS_1_1I2CDeviceManager.html#afc5ae9404b44c0361cfcc7bdaf864dc9">  351</a></span>&#160;uint32_t <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#afc5ae9404b44c0361cfcc7bdaf864dc9">I2CDeviceManager::get_bus_mask_external</a>(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="comment">// assume first bus is internal</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classChibiOS_1_1I2CDeviceManager.html#ad965b8e3841f7adda788b472d8288a78">get_bus_mask</a>() &amp; ~<a class="code" href="chibios_8h.html#a92c1036d708a9d3b99a1bf93f35ca71e">HAL_I2C_INTERNAL_MASK</a>;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;}</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="preprocessor">#endif // HAL_USE_I2C</span></div><div class="ttc" id="classChibiOS_1_1I2CDevice_html_a49868f6cbd67bc4755b33a8c1b7e9f77"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a49868f6cbd67bc4755b33a8c1b7e9f77">ChibiOS::I2CDevice::register_periodic_callback</a></div><div class="ttdeci">AP_HAL::Device::PeriodicHandle register_periodic_callback(uint32_t period_usec, AP_HAL::Device::PeriodicCb) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00303">I2CDevice.cpp:303</a></div></div>
<div class="ttc" id="stm32__util_8h_html"><div class="ttname"><a href="stm32__util_8h.html">stm32_util.h</a></div></div>
<div class="ttc" id="structI2CInfo_html_a112cbfb7c93d72b5f5af36e06f3a7cc1"><div class="ttname"><a href="structI2CInfo.html#a112cbfb7c93d72b5f5af36e06f3a7cc1">I2CInfo::scl_line</a></div><div class="ttdeci">ioline_t scl_line</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00033">I2CDevice.cpp:33</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_ac124e37d9964ffb269dce287c040146d"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#ac124e37d9964ffb269dce287c040146d">ChibiOS::I2CBus::dma_lock</a></div><div class="ttdeci">mutex_t dma_lock</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00047">I2CDevice.h:47</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_a9174696454e25295edb89aac743e95b2"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#a9174696454e25295edb89aac743e95b2">ChibiOS::I2CBus::dma_allocate</a></div><div class="ttdeci">void dma_allocate(Shared_DMA *)</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00181">I2CDevice.cpp:181</a></div></div>
<div class="ttc" id="structI2CInfo_html_a86b185023febb72e80bb3a093a68956d"><div class="ttname"><a href="structI2CInfo.html#a86b185023febb72e80bb3a093a68956d">I2CInfo::dma_channel_rx</a></div><div class="ttdeci">uint8_t dma_channel_rx</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00031">I2CDevice.cpp:31</a></div></div>
<div class="ttc" id="chibios_8h_html_a92c1036d708a9d3b99a1bf93f35ca71e"><div class="ttname"><a href="chibios_8h.html#a92c1036d708a9d3b99a1bf93f35ca71e">HAL_I2C_INTERNAL_MASK</a></div><div class="ttdeci">#define HAL_I2C_INTERNAL_MASK</div><div class="ttdef"><b>Definition:</b> <a href="chibios_8h_source.html#l00096">chibios.h:96</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_ab978a5c214ad4abcb89035bab4ce6055"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#ab978a5c214ad4abcb89035bab4ce6055">ChibiOS::I2CDevice::read_registers_multiple</a></div><div class="ttdeci">bool read_registers_multiple(uint8_t first_reg, uint8_t *recv, uint32_t recv_len, uint8_t times) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00293">I2CDevice.cpp:293</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_a3f542c806f81e1a334ccd03b7c87c7b6"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#a3f542c806f81e1a334ccd03b7c87c7b6">ChibiOS::I2CBus::dma_deallocate</a></div><div class="ttdeci">void dma_deallocate(Shared_DMA *)</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00188">I2CDevice.cpp:188</a></div></div>
<div class="ttc" id="AP__HAL_8h_html"><div class="ttname"><a href="AP__HAL_8h.html">AP_HAL.h</a></div></div>
<div class="ttc" id="classAP__HAL_1_1HAL_html_a92168462febe0f5ab9556dc9ea4ddb7a"><div class="ttname"><a href="classAP__HAL_1_1HAL.html#a92168462febe0f5ab9556dc9ea4ddb7a">AP_HAL::HAL::console</a></div><div class="ttdeci">AP_HAL::UARTDriver * console</div><div class="ttdef"><b>Definition:</b> <a href="HAL_8h_source.html#l00110">HAL.h:110</a></div></div>
<div class="ttc" id="stdio_8h_html_a1af9acc6b6efdca3576cb8223d95f401"><div class="ttname"><a href="stdio_8h.html#a1af9acc6b6efdca3576cb8223d95f401">asprintf</a></div><div class="ttdeci">int asprintf(char **strp, const char *fmt,...)</div><div class="ttdef"><b>Definition:</b> <a href="stdio_8cpp_source.html#l00109">stdio.cpp:109</a></div></div>
<div class="ttc" id="stdio_8h_html_a55f3d956bb2ba20b5059e9e25484a47f"><div class="ttname"><a href="stdio_8h.html#a55f3d956bb2ba20b5059e9e25484a47f">printf</a></div><div class="ttdeci">int printf(const char *fmt,...)</div><div class="ttdef"><b>Definition:</b> <a href="stdio_8cpp_source.html#l00131">stdio.cpp:131</a></div></div>
<div class="ttc" id="structI2CInfo_html_a718c2d9a8954e11510625f1301088539"><div class="ttname"><a href="structI2CInfo.html#a718c2d9a8954e11510625f1301088539">I2CInfo::i2c</a></div><div class="ttdeci">struct I2CDriver * i2c</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00030">I2CDevice.cpp:30</a></div></div>
<div class="ttc" id="classAP__HAL_1_1Device_html_a51dc074d450d02eedf40229f33d80c16"><div class="ttname"><a href="classAP__HAL_1_1Device.html#a51dc074d450d02eedf40229f33d80c16">AP_HAL::Device::get_bus_id</a></div><div class="ttdeci">uint32_t get_bus_id(void) const</div><div class="ttdef"><b>Definition:</b> <a href="Device_8h_source.html#l00061">Device.h:61</a></div></div>
<div class="ttc" id="classAP__HAL_1_1Device_html_a5f5d708368bd4779f30377409b56bbca"><div class="ttname"><a href="classAP__HAL_1_1Device.html#a5f5d708368bd4779f30377409b56bbca">AP_HAL::Device::set_device_bus</a></div><div class="ttdeci">void set_device_bus(uint8_t bus)</div><div class="ttdef"><b>Definition:</b> <a href="Device_8h_source.html#l00292">Device.h:292</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_a290885ad197d937f6a6c63828008d966"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#a290885ad197d937f6a6c63828008d966">ChibiOS::I2CBus::busclock</a></div><div class="ttdeci">uint32_t busclock</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00041">I2CDevice.h:41</a></div></div>
<div class="ttc" id="classChibiOS_1_1DeviceBus_html_a479b9906ae9f6fc2461b1f0b240dc27f"><div class="ttname"><a href="classChibiOS_1_1DeviceBus.html#a479b9906ae9f6fc2461b1f0b240dc27f">ChibiOS::DeviceBus::bouncebuffer_setup</a></div><div class="ttdeci">void bouncebuffer_setup(const uint8_t *&amp;buf_tx, uint16_t tx_len, uint8_t *&amp;buf_rx, uint16_t rx_len)</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2Device_8cpp_source.html#l00163">Device.cpp:163</a></div></div>
<div class="ttc" id="classAP__HAL_1_1HAL_html_a9337a60383f4264fa96a20dbe43a4e2e"><div class="ttname"><a href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">AP_HAL::HAL::util</a></div><div class="ttdeci">AP_HAL::Util * util</div><div class="ttdef"><b>Definition:</b> <a href="HAL_8h_source.html#l00115">HAL.h:115</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_a4622102073859d0e905ddcd0fc37a08c"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a4622102073859d0e905ddcd0fc37a08c">ChibiOS::I2CDevice::pname</a></div><div class="ttdeci">char * pname</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00107">I2CDevice.h:107</a></div></div>
<div class="ttc" id="AP__HAL__ChibiOS_2I2CDevice_8cpp_html_a66ed6e2c22eca428363d38855df34402"><div class="ttname"><a href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#a66ed6e2c22eca428363d38855df34402">HAL_I2C_F7_400_TIMINGR</a></div><div class="ttdeci">#define HAL_I2C_F7_400_TIMINGR</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00054">I2CDevice.cpp:54</a></div></div>
<div class="ttc" id="structI2CInfo_html_a166839b391b41faeefcad8284b5012e8"><div class="ttname"><a href="structI2CInfo.html#a166839b391b41faeefcad8284b5012e8">I2CInfo::dma_channel_tx</a></div><div class="ttdeci">uint8_t dma_channel_tx</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00032">I2CDevice.cpp:32</a></div></div>
<div class="ttc" id="ChibiOS_2I2CDevice_8h_html"><div class="ttname"><a href="ChibiOS_2I2CDevice_8h.html">I2CDevice.h</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_a08c367960abb5b5f19a9eabd27454d6c"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a08c367960abb5b5f19a9eabd27454d6c">ChibiOS::I2CDevice::_split_transfers</a></div><div class="ttdeci">bool _split_transfers</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00108">I2CDevice.h:108</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDeviceManager_html_af896f66bf6ef713752ed0b4acdf2639b"><div class="ttname"><a href="classChibiOS_1_1I2CDeviceManager.html#af896f66bf6ef713752ed0b4acdf2639b">ChibiOS::I2CDeviceManager::I2CDevice</a></div><div class="ttdeci">friend class I2CDevice</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00115">I2CDevice.h:115</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_aebf54d150dca31a5bd8ddd524cb5bb00"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#aebf54d150dca31a5bd8ddd524cb5bb00">ChibiOS::I2CDevice::~I2CDevice</a></div><div class="ttdeci">~I2CDevice()</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00169">I2CDevice.cpp:169</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_a0ee932744e9baa1fff2a3fe58a0b363b"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a0ee932744e9baa1fff2a3fe58a0b363b">ChibiOS::I2CDevice::adjust_periodic_callback</a></div><div class="ttdeci">bool adjust_periodic_callback(AP_HAL::Device::PeriodicHandle h, uint32_t period_usec) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00312">I2CDevice.cpp:312</a></div></div>
<div class="ttc" id="AP__Math_8h_html_a5abc8871f1e7781a55afe9bf299f0a39"><div class="ttname"><a href="AP__Math_8h.html#a5abc8871f1e7781a55afe9bf299f0a39">MAX</a></div><div class="ttdeci">static auto MAX(const A &amp;one, const B &amp;two) -&gt; decltype(one &gt; two ? one :two)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Math_8h_source.html#l00208">AP_Math.h:208</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_a5d57204892e08123b27539b5826ed5f2"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a5d57204892e08123b27539b5826ed5f2">ChibiOS::I2CDevice::_timeout_ms</a></div><div class="ttdeci">uint32_t _timeout_ms</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00110">I2CDevice.h:110</a></div></div>
<div class="ttc" id="classAP__HAL_1_1OwnPtr_html"><div class="ttname"><a href="classAP__HAL_1_1OwnPtr.html">AP_HAL::OwnPtr&lt; AP_HAL::I2CDevice &gt;</a></div></div>
<div class="ttc" id="classChibiOS_1_1DeviceBus_html_a5e916b7cbe184547b8a9521f56ea3104"><div class="ttname"><a href="classChibiOS_1_1DeviceBus.html#a5e916b7cbe184547b8a9521f56ea3104">ChibiOS::DeviceBus::dma_handle</a></div><div class="ttdeci">Shared_DMA * dma_handle</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2Device_8h_source.html#l00036">Device.h:36</a></div></div>
<div class="ttc" id="classAP__HAL_1_1BetterStream_html_a8534aa004599bb81ad60f3e762791032"><div class="ttname"><a href="classAP__HAL_1_1BetterStream.html#a8534aa004599bb81ad60f3e762791032">AP_HAL::BetterStream::printf</a></div><div class="ttdeci">virtual void printf(const char *,...) FMT_PRINTF(2</div><div class="ttdef"><b>Definition:</b> <a href="BetterStream_8cpp_source.html#l00005">BetterStream.cpp:5</a></div></div>
<div class="ttc" id="classAP__HAL_1_1HAL_html"><div class="ttname"><a href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a></div><div class="ttdef"><b>Definition:</b> <a href="HAL_8h_source.html#l00021">HAL.h:21</a></div></div>
<div class="ttc" id="classChibiOS_1_1Semaphore_html_a9b3100381eab8d8c7640f4fa5f2fe367"><div class="ttname"><a href="classChibiOS_1_1Semaphore.html#a9b3100381eab8d8c7640f4fa5f2fe367">ChibiOS::Semaphore::check_owner</a></div><div class="ttdeci">bool check_owner(void)</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2Semaphores_8cpp_source.html#l00068">Semaphores.cpp:68</a></div></div>
<div class="ttc" id="ICM20789_8cpp_html_a73e56d364aa23cb788be9693c10ef7e9"><div class="ttname"><a href="ICM20789_8cpp.html#a73e56d364aa23cb788be9693c10ef7e9">dev</a></div><div class="ttdeci">static AP_HAL::OwnPtr&lt; AP_HAL::Device &gt; dev</div><div class="ttdef"><b>Definition:</b> <a href="ICM20789_8cpp_source.html#l00016">ICM20789.cpp:16</a></div></div>
<div class="ttc" id="AP__HAL__ChibiOS_2I2CDevice_8cpp_html_ac0bae386fcc29b708566d7682b47b276"><div class="ttname"><a href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac0bae386fcc29b708566d7682b47b276">HAL_I2C_MAX_CLOCK</a></div><div class="ttdeci">#define HAL_I2C_MAX_CLOCK</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00049">I2CDevice.cpp:49</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_a4521f53fbe6997f9fc3453391ec769de"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#a4521f53fbe6997f9fc3453391ec769de">ChibiOS::I2CBus::i2ccfg</a></div><div class="ttdeci">I2CConfig i2ccfg</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00039">I2CDevice.h:39</a></div></div>
<div class="ttc" id="AP__HAL__ChibiOS_2I2CDevice_8cpp_html_ac711944dd4380c125a7c613364311554"><div class="ttname"><a href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ac711944dd4380c125a7c613364311554">I2CD</a></div><div class="ttdeci">static const struct I2CInfo I2CD[]</div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_a0bae064bcf2539888a94b2310e453f90"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#a0bae064bcf2539888a94b2310e453f90">ChibiOS::I2CBus::read_sda</a></div><div class="ttdeci">static uint8_t read_sda(uint8_t busidx)</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00100">I2CDevice.cpp:100</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_a67668d2130c5f77787d4d28e295db7f4"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a67668d2130c5f77787d4d28e295db7f4">ChibiOS::I2CDevice::bus</a></div><div class="ttdeci">I2CBus &amp; bus</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00100">I2CDevice.h:100</a></div></div>
<div class="ttc" id="classChibiOS_1_1DeviceBus_html_a29e22a909c9217f9e458d173f96c4655"><div class="ttname"><a href="classChibiOS_1_1DeviceBus.html#a29e22a909c9217f9e458d173f96c4655">ChibiOS::DeviceBus::semaphore</a></div><div class="ttdeci">Semaphore semaphore</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2Device_8h_source.html#l00035">Device.h:35</a></div></div>
<div class="ttc" id="classAP__HAL_1_1Device_html_a93226579e055533dd07379b2cb55ea7e"><div class="ttname"><a href="classAP__HAL_1_1Device.html#a93226579e055533dd07379b2cb55ea7e">AP_HAL::Device::PeriodicHandle</a></div><div class="ttdeci">void * PeriodicHandle</div><div class="ttdef"><b>Definition:</b> <a href="Device_8h_source.html#l00043">Device.h:43</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_a21a03f46d6b4c8d603df4a71a93a65b2"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a21a03f46d6b4c8d603df4a71a93a65b2">ChibiOS::I2CDevice::_transfer</a></div><div class="ttdeci">bool _transfer(const uint8_t *send, uint32_t send_len, uint8_t *recv, uint32_t recv_len)</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00240">I2CDevice.cpp:240</a></div></div>
<div class="ttc" id="structAP__HAL_1_1Util_1_1PersistentData_html_a6fae0db0f91fce53a13ff9e25f74e058"><div class="ttname"><a href="structAP__HAL_1_1Util_1_1PersistentData.html#a6fae0db0f91fce53a13ff9e25f74e058">AP_HAL::Util::PersistentData::i2c_count</a></div><div class="ttdeci">uint32_t i2c_count</div><div class="ttdef"><b>Definition:</b> <a href="Util_8h_source.html#l00068">Util.h:68</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html">ChibiOS::I2CBus</a></div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00037">I2CDevice.h:37</a></div></div>
<div class="ttc" id="AP__Math_8h_html"><div class="ttname"><a href="AP__Math_8h.html">AP_Math.h</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_acda87a68781e50471e6e8c20a7ec0541"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#acda87a68781e50471e6e8c20a7ec0541">ChibiOS::I2CDevice::transfer</a></div><div class="ttdeci">bool transfer(const uint8_t *send, uint32_t send_len, uint8_t *recv, uint32_t recv_len) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00192">I2CDevice.cpp:192</a></div></div>
<div class="ttc" id="AP__Common_8h_html_a121caf32c5b5d704ef3453f0885a9ea5"><div class="ttname"><a href="AP__Common_8h.html#a121caf32c5b5d704ef3453f0885a9ea5">ARRAY_SIZE</a></div><div class="ttdeci">#define ARRAY_SIZE(_arr)</div><div class="ttdef"><b>Definition:</b> <a href="AP__Common_8h_source.html#l00082">AP_Common.h:82</a></div></div>
<div class="ttc" id="classAP__HAL_1_1I2CDevice_html_ac84c9ea3fa0179792f138376516104e1"><div class="ttname"><a href="classAP__HAL_1_1I2CDevice.html#ac84c9ea3fa0179792f138376516104e1">AP_HAL::I2CDevice::I2CDevice</a></div><div class="ttdeci">I2CDevice()</div><div class="ttdef"><b>Definition:</b> <a href="I2CDevice_8h_source.html#l00030">I2CDevice.h:30</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDeviceManager_html_aa1c3df90c4c4c10caddb61aa773168da"><div class="ttname"><a href="classChibiOS_1_1I2CDeviceManager.html#aa1c3df90c4c4c10caddb61aa773168da">ChibiOS::I2CDeviceManager::businfo</a></div><div class="ttdeci">static I2CBus businfo[]</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00117">I2CDevice.h:117</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDeviceManager_html_a22a5da06be499ef4519fce386f435626"><div class="ttname"><a href="classChibiOS_1_1I2CDeviceManager.html#a22a5da06be499ef4519fce386f435626">ChibiOS::I2CDeviceManager::get_bus_mask_internal</a></div><div class="ttdeci">uint32_t get_bus_mask_internal(void) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00342">I2CDevice.cpp:342</a></div></div>
<div class="ttc" id="ChibiOS_2Util_8h_html"><div class="ttname"><a href="ChibiOS_2Util_8h.html">Util.h</a></div></div>
<div class="ttc" id="namespaceChibiOS_html"><div class="ttname"><a href="namespaceChibiOS.html">ChibiOS</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS__Namespace_8h_source.html#l00003">AP_HAL_ChibiOS_Namespace.h:3</a></div></div>
<div class="ttc" id="malloc_8c_html_afbedc913aa4651b3c3b4b3aecd9b4711"><div class="ttname"><a href="malloc_8c.html#afbedc913aa4651b3c3b4b3aecd9b4711">free</a></div><div class="ttdeci">void free(void *ptr)</div><div class="ttdef"><b>Definition:</b> <a href="malloc_8c_source.html#l00208">malloc.c:208</a></div></div>
<div class="ttc" id="AP__HAL__ChibiOS_2I2CDevice_8cpp_html_aa3a1fa01d8ad08cd740c710b0093451e"><div class="ttname"><a href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#aa3a1fa01d8ad08cd740c710b0093451e">HAL_I2C_BUS_BASE</a></div><div class="ttdeci">#define HAL_I2C_BUS_BASE</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00043">I2CDevice.cpp:43</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_aa267e7620497038a0e3386c3b78e5517"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#aa267e7620497038a0e3386c3b78e5517">ChibiOS::I2CDevice::_retries</a></div><div class="ttdeci">uint8_t _retries</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00105">I2CDevice.h:105</a></div></div>
<div class="ttc" id="ChibiOS_2Scheduler_8h_html"><div class="ttname"><a href="ChibiOS_2Scheduler_8h.html">Scheduler.h</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_a35c56dc7197d08e6e3dceaede80c3bda"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#a35c56dc7197d08e6e3dceaede80c3bda">ChibiOS::I2CBus::dma_init</a></div><div class="ttdeci">void dma_init(void)</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00064">I2CDevice.cpp:64</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_aab8555f70bcaceb49f6d26f92a8b3af6"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#aab8555f70bcaceb49f6d26f92a8b3af6">ChibiOS::I2CBus::clear_all</a></div><div class="ttdeci">static void clear_all(void)</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00073">I2CDevice.cpp:73</a></div></div>
<div class="ttc" id="structI2CInfo_html"><div class="ttname"><a href="structI2CInfo.html">I2CInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00029">I2CDevice.cpp:29</a></div></div>
<div class="ttc" id="classAP__HAL_1_1Scheduler_html_a78c4f1b1f192ac1c99544b6cc8f099b0"><div class="ttname"><a href="classAP__HAL_1_1Scheduler.html#a78c4f1b1f192ac1c99544b6cc8f099b0">AP_HAL::Scheduler::delay_microseconds</a></div><div class="ttdeci">virtual void delay_microseconds(uint16_t us)=0</div></div>
<div class="ttc" id="classChibiOS_1_1DeviceBus_html_ac9b1fc7ac63003c96c79f4ff49f5f0bd"><div class="ttname"><a href="classChibiOS_1_1DeviceBus.html#ac9b1fc7ac63003c96c79f4ff49f5f0bd">ChibiOS::DeviceBus::register_periodic_callback</a></div><div class="ttdeci">AP_HAL::Device::PeriodicHandle register_periodic_callback(uint32_t period_usec, AP_HAL::Device::PeriodicCb, AP_HAL::Device *hal_device)</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2Device_8cpp_source.html#l00094">Device.cpp:94</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDeviceManager_html"><div class="ttname"><a href="classChibiOS_1_1I2CDeviceManager.html">ChibiOS::I2CDeviceManager</a></div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00113">I2CDevice.h:113</a></div></div>
<div class="ttc" id="AP__HAL__ChibiOS_2I2CDevice_8cpp_html_a184fb530485402da7e21c274855b0436"><div class="ttname"><a href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#a184fb530485402da7e21c274855b0436">HAL_I2C_F7_100_TIMINGR</a></div><div class="ttdeci">#define HAL_I2C_F7_100_TIMINGR</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00053">I2CDevice.cpp:53</a></div></div>
<div class="ttc" id="classAP__HAL_1_1Util_html_a64273fdab59825cea305a403054c25bf"><div class="ttname"><a href="classAP__HAL_1_1Util.html#a64273fdab59825cea305a403054c25bf">AP_HAL::Util::persistent_data</a></div><div class="ttdeci">struct PersistentData persistent_data</div><div class="ttdef"><b>Definition:</b> <a href="Util_8h_source.html#l00070">Util.h:70</a></div></div>
<div class="ttc" id="classChibiOS_1_1DeviceBus_html_adac0a2a450eee9ee70df8c45f9d3bae2"><div class="ttname"><a href="classChibiOS_1_1DeviceBus.html#adac0a2a450eee9ee70df8c45f9d3bae2">ChibiOS::DeviceBus::adjust_timer</a></div><div class="ttdeci">bool adjust_timer(AP_HAL::Device::PeriodicHandle h, uint32_t period_usec)</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2Device_8cpp_source.html#l00146">Device.cpp:146</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_a2170a7c8dc425809db682bed380abd4f"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#a2170a7c8dc425809db682bed380abd4f">ChibiOS::I2CBus::clear_bus</a></div><div class="ttdeci">static void clear_bus(uint8_t busidx)</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00085">I2CDevice.cpp:85</a></div></div>
<div class="ttc" id="AP__HAL__ChibiOS_2I2CDevice_8cpp_html_ae08c3ca4ba26b63cda0bb3e3c6c02785"><div class="ttname"><a href="AP__HAL__ChibiOS_2I2CDevice_8cpp.html#ae08c3ca4ba26b63cda0bb3e3c6c02785">hal</a></div><div class="ttdeci">const AP_HAL::HAL &amp; hal</div><div class="ttdef"><b>Definition:</b> <a href="AC__PID__test_8cpp_source.html#l00021">AC_PID_test.cpp:21</a></div></div>
<div class="ttc" id="functor_8h_html_a00e5874203cecc310017f9166f2c0e36"><div class="ttname"><a href="functor_8h.html#a00e5874203cecc310017f9166f2c0e36">FUNCTOR_BIND_MEMBER</a></div><div class="ttdeci">#define FUNCTOR_BIND_MEMBER(func, rettype,...)</div><div class="ttdef"><b>Definition:</b> <a href="functor_8h_source.html#l00031">functor.h:31</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_a5ce66a1a3aff0242e164aab35421a450"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a5ce66a1a3aff0242e164aab35421a450">ChibiOS::I2CDevice::_use_smbus</a></div><div class="ttdeci">bool _use_smbus</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00109">I2CDevice.h:109</a></div></div>
<div class="ttc" id="classChibiOS_1_1DeviceBus_html_a9cfb645fb170b85b11b6a87463a6ccf9"><div class="ttname"><a href="classChibiOS_1_1DeviceBus.html#a9cfb645fb170b85b11b6a87463a6ccf9">ChibiOS::DeviceBus::bouncebuffer_finish</a></div><div class="ttdeci">void bouncebuffer_finish(const uint8_t *buf_tx, uint8_t *buf_rx, uint16_t rx_len)</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2Device_8cpp_source.html#l00177">Device.cpp:177</a></div></div>
<div class="ttc" id="classAP__HAL_1_1Device_html_afb5df3da326300740856c48d338d4cf2"><div class="ttname"><a href="classAP__HAL_1_1Device.html#afb5df3da326300740856c48d338d4cf2">AP_HAL::Device::set_device_address</a></div><div class="ttdeci">void set_device_address(uint8_t address)</div><div class="ttdef"><b>Definition:</b> <a href="Device_8h_source.html#l00287">Device.h:287</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDevice_html_a48f0f37269a9d6b464591e307fbd3335"><div class="ttname"><a href="classChibiOS_1_1I2CDevice.html#a48f0f37269a9d6b464591e307fbd3335">ChibiOS::I2CDevice::_address</a></div><div class="ttdeci">uint8_t _address</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00106">I2CDevice.h:106</a></div></div>
<div class="ttc" id="structI2CInfo_html_aba869fbc255486788b2f7b3abc9586bb"><div class="ttname"><a href="structI2CInfo.html#aba869fbc255486788b2f7b3abc9586bb">I2CInfo::sda_line</a></div><div class="ttdeci">ioline_t sda_line</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00034">I2CDevice.cpp:34</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CBus_html_a7ba635eb1758b31997388a8fb72ab2c5"><div class="ttname"><a href="classChibiOS_1_1I2CBus.html#a7ba635eb1758b31997388a8fb72ab2c5">ChibiOS::I2CBus::busnum</a></div><div class="ttdeci">uint8_t busnum</div><div class="ttdef"><b>Definition:</b> <a href="ChibiOS_2I2CDevice_8h_source.html#l00040">I2CDevice.h:40</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDeviceManager_html_ae435ba9feecd3133ef74a72ff5aa85c4"><div class="ttname"><a href="classChibiOS_1_1I2CDeviceManager.html#ae435ba9feecd3133ef74a72ff5aa85c4">ChibiOS::I2CDeviceManager::get_device</a></div><div class="ttdeci">AP_HAL::OwnPtr&lt; AP_HAL::I2CDevice &gt; get_device(uint8_t bus, uint8_t address, uint32_t bus_clock=400000, bool use_smbus=false, uint32_t timeout_ms=4) override</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00318">I2CDevice.cpp:318</a></div></div>
<div class="ttc" id="classAP__HAL_1_1HAL_html_a94ab41309b1ff10b8b862b826e59c882"><div class="ttname"><a href="classAP__HAL_1_1HAL.html#a94ab41309b1ff10b8b862b826e59c882">AP_HAL::HAL::scheduler</a></div><div class="ttdeci">AP_HAL::Scheduler * scheduler</div><div class="ttdef"><b>Definition:</b> <a href="HAL_8h_source.html#l00114">HAL.h:114</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDeviceManager_html_afc5ae9404b44c0361cfcc7bdaf864dc9"><div class="ttname"><a href="classChibiOS_1_1I2CDeviceManager.html#afc5ae9404b44c0361cfcc7bdaf864dc9">ChibiOS::I2CDeviceManager::get_bus_mask_external</a></div><div class="ttdeci">uint32_t get_bus_mask_external(void) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00351">I2CDevice.cpp:351</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDeviceManager_html_ad965b8e3841f7adda788b472d8288a78"><div class="ttname"><a href="classChibiOS_1_1I2CDeviceManager.html#ad965b8e3841f7adda788b472d8288a78">ChibiOS::I2CDeviceManager::get_bus_mask</a></div><div class="ttdeci">uint32_t get_bus_mask(void) const override</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00334">I2CDevice.cpp:334</a></div></div>
<div class="ttc" id="classChibiOS_1_1I2CDeviceManager_html_ae339d9be7bdce3f514b74f99ae879dfa"><div class="ttname"><a href="classChibiOS_1_1I2CDeviceManager.html#ae339d9be7bdce3f514b74f99ae879dfa">ChibiOS::I2CDeviceManager::I2CDeviceManager</a></div><div class="ttdeci">I2CDeviceManager()</div><div class="ttdef"><b>Definition:</b> <a href="AP__HAL__ChibiOS_2I2CDevice_8cpp_source.html#l00111">I2CDevice.cpp:111</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Jul 11 2019 14:17:28 for APM:Libraries by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
